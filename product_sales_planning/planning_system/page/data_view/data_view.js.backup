// product_sales_planning/planning_system/page/data_view/data_view.js

// 1. é¡µé¢åŠ è½½ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼Œç”¨äºåˆå§‹åŒ–ï¼‰
frappe.pages['data-view'].on_page_load = function(wrapper) {
	const page = frappe.ui.make_app_page({
		parent: wrapper,
		title: 'æ•°æ®æŸ¥çœ‹',
		single_column: true
	});

	// æ˜¾ç¤ºåˆå§‹åŠ è½½çŠ¶æ€
	$(wrapper).find('.layout-main-section').html(`
		<div id="data-view-app">
			<div class="text-center p-5">
				<div class="spinner-border text-primary" role="status"></div>
				<div class="mt-2 text-muted">æ­£åœ¨åŠ è½½èµ„æº...</div>
				<div class="mt-2 text-muted" style="font-size: 12px;">è¯·ç¨å€™ï¼Œæ­£åœ¨åˆå§‹åŒ–é¡µé¢ç»„ä»¶...</div>
			</div>
		</div>
	`);

	// åŠ è½½ Handsontable CSS å’Œ JSï¼ˆå¢å¼ºç‰ˆï¼‰
	load_handsontable_assets().then(() => {
		console.log('âœ… èµ„æºåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ç®¡ç†å™¨');
		// åˆ›å»ºå†…å®¹å®¹å™¨
		$(wrapper).find('.layout-main-section').html(`
			<div id="data-view-app">
				<div class="data-view-loading">
					<div class="spinner-border text-primary" role="status"></div>
					<div class="mt-2 text-muted">æ­£åœ¨åˆå§‹åŒ–é¡µé¢...</div>
				</div>
			</div>
		`);

		// åˆå§‹åŒ–ç®¡ç†å™¨
		wrapper.data_view_manager = new DataViewManager(wrapper, page);
	}).catch(error => {
		console.error('âŒ Handsontable åŠ è½½å¤±è´¥:', error);
		$(wrapper).find('.layout-main-section').html(`
			<div class="text-center p-5">
				<div class="alert alert-danger">
					<h4>èµ„æºåŠ è½½å¤±è´¥</h4>
					<p>${error.message}</p>
					<button class="btn btn-primary me-2" onclick="location.reload()">
						<i class="fa fa-refresh"></i> åˆ·æ–°é¡µé¢
					</button>
					<button class="btn btn-secondary" onclick="history.back()">
						<i class="fa fa-arrow-left"></i> è¿”å›ä¸Šä¸€é¡µ
					</button>
				</div>
			</div>
		`);
	});
};

// 2. é¡µé¢æ˜¾ç¤ºï¼ˆæ¯æ¬¡åˆ‡æ¢å›æ¥éƒ½ä¼šæ‰§è¡Œï¼‰
frappe.pages['data-view'].on_page_show = function(wrapper) {
	if (wrapper.data_view_manager && wrapper.data_view_manager.filter_group) {
		console.log("é¡µé¢æ˜¾ç¤ºï¼Œè‡ªåŠ¨åˆ·æ–°æ•°æ®...");
		wrapper.data_view_manager.fetch_data();
	}
};

// 3. é¡µé¢å¸è½½ï¼ˆæ¸…ç†èµ„æºï¼‰
frappe.pages['data-view'].on_page_unload = function(wrapper) {
	if (wrapper.data_view_manager) {
		if (wrapper.data_view_manager.gridApi) {
			wrapper.data_view_manager.gridApi.destroy();
		}
		wrapper.data_view_manager = null;
	}
};

// åŠ è½½ Handsontable èµ„æºï¼ˆä¼˜åŒ–ç‰ˆï¼‰
function load_handsontable_assets() {
	return new Promise((resolve, reject) => {
		// æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
		if (window.Handsontable) {
			console.log('âœ… Handsontable already loaded');
			resolve();
			return;
		}

		// è®¾ç½®è¶…æ—¶å¤„ç†
		const timeout = setTimeout(() => {
			reject(new Error('Handsontable èµ„æºåŠ è½½è¶…æ—¶'));
		}, 15000); // 15ç§’è¶…æ—¶

		// ä¸²è¡ŒåŠ è½½èµ„æºï¼Œç¡®ä¿åŠ è½½é¡ºåº
		const loadCSS = (id, href) => {
			return new Promise((res, rej) => {
				if (document.getElementById(id)) {
					console.log(`âœ… ${id} already exists`);
					res();
					return;
				}
				const link = document.createElement('link');
				link.id = id;
				link.rel = 'stylesheet';
				link.href = href;
				link.onload = () => {
					console.log(`âœ… ${id} loaded`);
					// ç­‰å¾…CSSåº”ç”¨åˆ°DOM
					setTimeout(res, 100);
				};
				link.onerror = () => {
					console.error(`âŒ ${id} loading failed`);
					rej(new Error(`${id}åŠ è½½å¤±è´¥`));
				};
				document.head.appendChild(link);
			});
		};

		const loadJS = (src) => {
			return new Promise((res, rej) => {
				const script = document.createElement('script');
				script.src = src;
				script.async = false;
				script.onload = () => {
					console.log('âœ… Handsontable JS loaded');
					// è½®è¯¢éªŒè¯ Handsontable å¯¹è±¡ï¼ˆå¢å¼ºç‰ˆï¼‰
					let retries = 0;
					const maxRetries = 30; // å¢åŠ é‡è¯•æ¬¡æ•°
					const checkHandsontable = () => {
						if (window.Handsontable && typeof window.Handsontable === 'function') {
							console.log('âœ… Handsontable object ready');
							clearTimeout(timeout);
							res();
						} else if (retries < maxRetries) {
							retries++;
							setTimeout(checkHandsontable, 100);
						} else {
							clearTimeout(timeout);
							rej(new Error('Handsontableå¯¹è±¡åˆå§‹åŒ–è¶…æ—¶'));
						}
					};
					checkHandsontable();
				};
				script.onerror = () => {
					console.error('âŒ Handsontable JS loading failed');
					clearTimeout(timeout);
					rej(new Error('Handsontable JSåŠ è½½å¤±è´¥'));
				};
				document.head.appendChild(script);
			});
		};

		// æŒ‰é¡ºåºåŠ è½½èµ„æºï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰
		const cssPath = '/assets/product_sales_planning/js/lib/handsontable.full.min.css';
		const jsPath = '/assets/product_sales_planning/js/lib/handsontable.full.min.js';

		loadCSS('handsontable-css', cssPath)
			.then(() => {
				console.log('âœ… CSS loaded, loading JS...');
				return loadJS(jsPath);
			})
			.then(() => {
				console.log('âœ… All Handsontable resources loaded successfully');
				clearTimeout(timeout);
				resolve();
			})
			.catch((error) => {
				console.error('âŒ Handsontable loading failed:', error);
				clearTimeout(timeout);
				reject(error);
			});
	});
}

// æ•°æ®æŸ¥çœ‹ç®¡ç†å™¨ç±»
class DataViewManager {
	constructor(wrapper, page) {
		this.wrapper = $(wrapper);
		this.page = page;
		this.current_page = 1;
		this.page_size = 50; // é»˜è®¤æ¯é¡µ50æ¡
		this.filters = {};
		this.filter_options = {
			tasks: [],
			stores: [],
			products: [],
			channels: []
		};
		this.data = {
			stats: {
				total_stores: 0,
				total_products: 0,
				total_quantity: 0,
				completed_stores: 0,
				pending_stores: 0,
				rejected_stores: 0
			},
			data: [],
			total: 0
		};
		this.gridApi = null;
		this.gridColumnApi = null;
		this.hot = null; // Handsontable å®ä¾‹
		this.cached_filters_key = 'data_view_column_filters'; // ç¼“å­˜é”®å

		this.init_ui();
	}

	init_ui() {
		this.page.clear_primary_action();
		this.page.set_primary_action('åˆ·æ–°', () => this.fetch_data());

		// æ·»åŠ è¿”å›æŒ‰é’®
		this.page.add_inner_button('è¿”å›é¦–é¡µ', () => {
			frappe.set_route('planning-dashboard');
		}, null, 'btn-default');

		// åˆ›å»ºå†…å®¹å®¹å™¨
		this.wrapper.find('#data-view-app').html(`
			<div class="data-view-body">
				<!-- ç»Ÿè®¡ä¿¡æ¯ -->
				<div class="stats-section">
					<div class="stat-card">
						<div class="stat-icon-box box-blue">${frappe.utils.icon('package', 'md')}</div>
						<div class="stat-content">
							<h4 id="stat-total-quantity">0</h4>
							<span>æ€»æ•°é‡</span>
						</div>
					</div>
					<div class="stat-card">
						<div class="stat-icon-box box-success">${frappe.utils.icon('check-circle', 'md')}</div>
						<div class="stat-content">
							<h4 id="stat-completed-stores">0</h4>
							<span>å·²å®Œæˆåº—é“º</span>
						</div>
					</div>
					<div class="stat-card">
						<div class="stat-icon-box box-warning">${frappe.utils.icon('clock', 'md')}</div>
						<div class="stat-content">
							<h4 id="stat-pending-stores">0</h4>
							<span>å¾…å®¡æ‰¹åº—é“º</span>
						</div>
					</div>
					<div class="stat-card">
						<div class="stat-icon-box box-danger">${frappe.utils.icon('x-circle', 'md')}</div>
						<div class="stat-content">
							<h4 id="stat-rejected-stores">0</h4>
							<span>å·²é©³å›åº—é“º</span>
						</div>
					</div>
				</div>

				<!-- ç­›é€‰å™¨åŒºåŸŸ -->
				<div class="filters-section">
					<div class="filter-card">
						<div class="filter-controls-row row">
							<div class="col-md-2 col-sm-6 col-12 filter-task"></div>
							<div class="col-md-2 col-sm-6 col-12 filter-store"></div>
							<div class="col-md-2 col-sm-6 col-12 filter-product"></div>
							<div class="col-md-2 col-sm-6 col-12 filter-channel"></div>
							<div class="col-md-2 col-sm-6 col-12 filter-approval-status"></div>
							<div class="col-md-2 col-sm-6 col-12 filter-submission-status"></div>
						</div>
						<div class="filter-controls-row row" style="margin-top: 10px;">
							<div class="col-12 filter-actions">
								<button class="btn btn-sm btn-default btn-clear-filters" title="æ¸…ç©ºç­›é€‰">
									<i class="fa fa-eraser"></i> æ¸…ç©º
								</button>
								<button class="btn btn-sm btn-primary btn-apply-filters" title="åº”ç”¨ç­›é€‰">
									<i class="fa fa-search"></i> æŸ¥è¯¢
								</button>
							</div>
						</div>
					</div>
				</div>

				<!-- åˆ—è®¾ç½®åŒºåŸŸ -->
				<div class="column-settings-section">
					<div class="column-settings-card">
						<div class="column-settings-header">
							<div class="column-settings-title">
								<i class="fa fa-columns"></i>åˆ—æ˜¾ç¤ºè®¾ç½®
							</div>
							<div class="column-settings-actions">
								<button class="btn btn-sm btn-default btn-toggle-column-settings">
									<i class="fa fa-cog"></i> ç®¡ç†åˆ—
								</button>
								<button class="btn btn-sm btn-primary btn-export-excel">
									<i class="fa fa-file-excel-o"></i> å¯¼å‡º Excel
								</button>
							</div>
						</div>
						<div id="column-checkboxes" class="column-checkboxes">
							<!-- åˆ—å¤é€‰æ¡†å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
						</div>
					</div>
				</div>

				<!-- Handsontable è¡¨æ ¼åŒºåŸŸ -->
				<div class="handsontable-container" style="position: relative;">
					<div id="data-grid"></div>
					
					<!-- åˆ†é¡µæ§ä»¶ - ç§»åˆ°å³ä¸‹è§’ -->
					<div class="pagination-section" style="position: absolute; bottom: 10px; right: 10px; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100;">
						<div class="pagination-card" style="margin: 0;">
							<div class="pagination-info" style="margin-bottom: 8px; text-align: center;">
								å…± <strong id="total-records">0</strong> æ¡è®°å½•
							</div>
							<div class="pagination-controls" style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap; justify-content: center;">
								<span class="pagination-page-info" style="margin-right: 5px;">
									ç¬¬ <strong id="current-page">1</strong> / <strong id="total-pages">1</strong> é¡µ
								</span>
								<button class="btn btn-sm btn-default btn-first-page" title="é¦–é¡µ">
									<i class="fa fa-angle-double-left"></i>
								</button>
								<button class="btn btn-sm btn-default btn-prev-page" title="ä¸Šä¸€é¡µ">
									<i class="fa fa-angle-left"></i>
								</button>
								<select class="form-control input-sm" id="page-size-selector" style="width: auto; display: inline-block;">
									<option value="20">20æ¡/é¡µ</option>
									<option value="50" selected>50æ¡/é¡µ</option>
									<option value="100">100æ¡/é¡µ</option>
									<option value="200">200æ¡/é¡µ</option>
									<option value="500">500æ¡/é¡µ</option>
								</select>
								<button class="btn btn-sm btn-default btn-next-page" title="ä¸‹ä¸€é¡µ">
									<i class="fa fa-angle-right"></i>
								</button>
								<button class="btn btn-sm btn-default btn-last-page" title="æœ«é¡µ">
									<i class="fa fa-angle-double-right"></i>
								</button>
								<span class="pagination-goto-text" style="margin-left: 5px;">è·³è½¬</span>
								<input type="number" class="form-control input-sm" id="goto-page-input" min="1" placeholder="é¡µç " style="width: 60px; display: inline-block;">
								<button class="btn btn-sm btn-primary btn-goto-page">GO</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		`);

		// ç»‘å®šæŒ‰é’®äº‹ä»¶
		this.wrapper.find('.btn-clear-filters').on('click', () => this.clear_filters());
		this.wrapper.find('.btn-apply-filters').on('click', () => this.apply_filters());
		this.wrapper.find('.btn-export-excel').on('click', () => this.export_excel());
		this.wrapper.find('.btn-toggle-column-settings').on('click', () => this.toggle_column_settings());

		// ç»‘å®šåˆ†é¡µæŒ‰é’®äº‹ä»¶
		this.wrapper.find('.btn-first-page').on('click', () => this.goto_page(1));
		this.wrapper.find('.btn-prev-page').on('click', () => this.goto_page(this.current_page - 1));
		this.wrapper.find('.btn-next-page').on('click', () => this.goto_page(this.current_page + 1));
		this.wrapper.find('.btn-last-page').on('click', () => {
			const totalPages = Math.ceil(this.data.total / this.page_size);
			this.goto_page(totalPages);
		});
		this.wrapper.find('.btn-goto-page').on('click', () => {
			const page = parseInt(this.wrapper.find('#goto-page-input').val());
			if (page && page > 0) {
				this.goto_page(page);
			}
		});
		this.wrapper.find('#goto-page-input').on('keypress', (e) => {
			if (e.which === 13) { // Enteré”®
				const page = parseInt(this.wrapper.find('#goto-page-input').val());
				if (page && page > 0) {
					this.goto_page(page);
				}
			}
		});
		this.wrapper.find('#page-size-selector').on('change', (e) => {
			this.page_size = parseInt($(e.target).val());
			this.current_page = 1;
			this.fetch_data();
		});

		this.init_filter_fields();
		this.init_handsontable();
	}

	init_filter_fields() {
		const self = this;

		// æ¸…ç©ºç­›é€‰å™¨å®¹å™¨ï¼Œé˜²æ­¢é‡å¤æ¸²æŸ“
		this.wrapper.find('.filter-task').empty();
		this.wrapper.find('.filter-store').empty();
		this.wrapper.find('.filter-product').empty();
		this.wrapper.find('.filter-channel').empty();
		this.wrapper.find('.filter-approval-status').empty();
		this.wrapper.find('.filter-submission-status').empty();

		// ç­‰å¾…ç­›é€‰å™¨é€‰é¡¹åŠ è½½å®Œæˆåå†åˆå§‹åŒ–å­—æ®µ
		this.fetch_filter_options().then(() => {
			self.filter_group = new frappe.ui.FieldGroup({
				fields: [
					{
						fieldname: 'task_ids',
						label: 'ä»»åŠ¡',
						fieldtype: 'Autocomplete',
						options: self.filter_options.tasks.map(t => {
							const dateRange = (t.start_date && t.end_date)
								? `${t.start_date} ~ ${t.end_date}`
								: (t.start_date || t.end_date || 'æ— æ—¥æœŸ');
							return `${t.name} (${dateRange})`;
						}),
						change: () => self.on_filter_change()
					},
					{
						fieldname: 'store_ids',
						label: 'åº—é“º',
						fieldtype: 'Autocomplete',
						options: self.filter_options.stores.map(s => `${s.shop_name} (${s.name})`),
						change: () => self.on_filter_change()
					},
					{
						fieldname: 'product_codes',
						label: 'å•†å“',
						fieldtype: 'Autocomplete',
						options: self.filter_options.products.map(p => `${p.name1 || p.name} (${p.code || p.name})`),
						change: () => self.on_filter_change()
					},
					{
						fieldname: 'channels',
						label: 'æ¸ é“',
						fieldtype: 'Autocomplete',
						options: self.filter_options.channels,
						change: () => self.on_filter_change()
					},
					{
						fieldname: 'approval_statuses',
						label: 'å®¡æ‰¹çŠ¶æ€',
						fieldtype: 'Select',
						options: ['', 'å¾…å®¡æ‰¹', 'å·²é€šè¿‡', 'å·²é©³å›'],
						change: () => self.on_filter_change()
					},
					{
						fieldname: 'submission_statuses',
						label: 'æäº¤çŠ¶æ€',
						fieldtype: 'Select',
						options: ['', 'æœªå¼€å§‹', 'å·²æäº¤'],
						change: () => self.on_filter_change()
					}
				],
				body: this.wrapper.find('.filter-card')
			});

			this.filter_group.make();

			// æ‰‹åŠ¨å¸ƒå±€åˆ° Grid
			const f = this.filter_group.fields_dict;
			if (f.task_ids) f.task_ids.$wrapper.appendTo(this.wrapper.find('.filter-task'));
			if (f.store_ids) f.store_ids.$wrapper.appendTo(this.wrapper.find('.filter-store'));
			if (f.product_codes) f.product_codes.$wrapper.appendTo(this.wrapper.find('.filter-product'));
			if (f.channels) f.channels.$wrapper.appendTo(this.wrapper.find('.filter-channel'));
			if (f.approval_statuses) f.approval_statuses.$wrapper.appendTo(this.wrapper.find('.filter-approval-status'));
			if (f.submission_statuses) f.submission_statuses.$wrapper.appendTo(this.wrapper.find('.filter-submission-status'));

			// ç­›é€‰å™¨åˆå§‹åŒ–å®Œæˆåï¼Œå°è¯•æ¢å¤ç¼“å­˜çš„ç­›é€‰å™¨å€¼
			setTimeout(() => {
				self.load_cached_filters();
			}, 100);

			// åŠ è½½æ•°æ®
			console.log('âœ… ç­›é€‰å™¨åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ®');
			this.fetch_data();
		}).catch(error => {
			console.error('âŒ ç­›é€‰å™¨åˆå§‹åŒ–å¤±è´¥:', error);
			frappe.msgprint('ç­›é€‰å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
			// å³ä½¿ç­›é€‰å™¨å¤±è´¥ï¼Œä¹Ÿå°è¯•åŠ è½½æ•°æ®
			this.fetch_data();
		});
	}

	// åˆå§‹åŒ– Handsontable
	init_handsontable() {
		const container = document.getElementById('data-grid');
		if (!container) {
			console.error('âŒ æ‰¾ä¸åˆ°è¡¨æ ¼å®¹å™¨');
			return;
		}

		// å®šä¹‰åˆ—é…ç½®
		this.columns = [
			{ data: 'shop_name', title: 'åº—é“ºåç§°', width: 150, readOnly: true },
			{ data: 'channel', title: 'æ¸ é“', width: 120, readOnly: true },
			{ data: 'code', title: 'å•†å“ç¼–ç ', width: 120, readOnly: true },
			{ data: 'product_name', title: 'å•†å“åç§°', width: 200, readOnly: true },
			{ data: 'specifications', title: 'è§„æ ¼', width: 150, readOnly: true },
			{ data: 'brand', title: 'å“ç‰Œ', width: 120, readOnly: true },
			{ data: 'category', title: 'ç±»åˆ«', width: 120, readOnly: true },
			{ data: 'quantity', title: 'æ•°é‡', width: 100, type: 'numeric' },
			{
				data: 'sub_date',
				title: 'æäº¤æ—¶é—´',
				width: 150,
				readOnly: true,
				renderer: (instance, td, row, col, prop, value) => {
					td.innerHTML = value ? new Date(value).toLocaleString('zh-CN', {
						year: 'numeric',
						month: '2-digit',
						day: '2-digit',
						hour: '2-digit',
						minute: '2-digit'
					}) : '-';
				}
			},
			{ data: 'approval_status', title: 'å®¡æ‰¹çŠ¶æ€', width: 100, readOnly: true },
			{ data: 'submission_status', title: 'æäº¤çŠ¶æ€', width: 100, readOnly: true },
			{ data: 'user', title: 'è´Ÿè´£äºº', width: 100, readOnly: true },
			{ data: 'task_type', title: 'ä»»åŠ¡ç±»å‹', width: 120, readOnly: true },
			{
				data: 'start_date',
				title: 'å¼€å§‹æ—¥æœŸ',
				width: 120,
				readOnly: true,
				renderer: (instance, td, row, col, prop, value) => {
					td.innerHTML = value ? new Date(value).toLocaleDateString('zh-CN') : '-';
				}
			},
			{
				data: 'end_date',
				title: 'ç»“æŸæ—¥æœŸ',
				width: 120,
				readOnly: true,
				renderer: (instance, td, row, col, prop, value) => {
					td.innerHTML = value ? new Date(value).toLocaleDateString('zh-CN') : '-';
				}
			}
		];

		// åˆå§‹åŒ– Handsontable å®ä¾‹
		this.hot = new Handsontable(container, {
			data: [],
			columns: this.columns,
			colHeaders: true,
			rowHeaders: true,
			width: '100%',
			height: 600,
			licenseKey: 'non-commercial-and-evaluation',
			copyPaste: true,
			manualColumnResize: true,
			manualColumnMove: true,
			manualRowResize: true,
			manualRowMove: false,
			filters: true,
			dropdownMenu: ['filter_by_condition', 'filter_by_value', 'filter_action_bar'],
			columnSorting: true,
			hiddenColumns: { indicators: true },
			selectionMode: 'multiple',
			language: 'zh-CN',
			wordWrap: false,
			fixedColumnsLeft: 2,
			renderAllRows: false,
			contextMenu: {
				items: {
					'row_above': { name: 'åœ¨ä¸Šæ–¹æ’å…¥è¡Œ' },
					'row_below': { name: 'åœ¨ä¸‹æ–¹æ’å…¥è¡Œ' },
					'separator1': '---------',
					'col_left': { name: 'åœ¨å·¦ä¾§æ’å…¥åˆ—' },
					'col_right': { name: 'åœ¨å³ä¾§æ’å…¥åˆ—' },
					'separator2': '---------',
					'remove_row': { name: 'åˆ é™¤è¡Œ' },
					'remove_col': { name: 'åˆ é™¤åˆ—' },
					'separator3': '---------',
					'undo': { name: 'æ’¤é”€' },
					'redo': { name: 'é‡åš' },
					'separator4': '---------',
					'make_read_only': { name: 'åªè¯»' },
					'alignment': { name: 'å¯¹é½æ–¹å¼' },
					'separator5': '---------',
					'copy': { name: 'å¤åˆ¶' },
					'cut': { name: 'å‰ªåˆ‡' },
					'separator6': '---------',
					'hidden_columns_show': { name: 'æ˜¾ç¤ºéšè—çš„åˆ—' },
					'hidden_columns_hide': { name: 'éšè—åˆ—' }
				}
			},
			afterChange: (changes, source) => {
				if (source !== 'loadData' && changes) {
					console.log('æ•°æ®å˜æ›´:', changes);
				}
			},
			afterFilter: () => this.cache_column_filters()
		});

		console.log('âœ… Handsontable è¡¨æ ¼åˆå§‹åŒ–å®Œæˆ');

		// åˆå§‹åŒ–åˆ—è®¾ç½®å’Œæ¢å¤ç¼“å­˜
		this.init_column_checkboxes();
		setTimeout(() => this.restore_column_filters(), 500);
	}

	// ç¼“å­˜ Handsontable åˆ—ç­›é€‰å™¨çŠ¶æ€
	cache_column_filters() {
		if (!this.hot) return;

		try {
			const filtersPlugin = this.hot.getPlugin('filters');
			if (filtersPlugin && filtersPlugin.isEnabled()) {
				const filterConditions = [];
				const columns = this.hot.countCols();

				for (let col = 0; col < columns; col++) {
					const conditions = filtersPlugin.getConditions(col);
					if (conditions && conditions.length > 0) {
						filterConditions.push({
							column: col,
							conditions: conditions
						});
					}
				}

				localStorage.setItem(this.cached_filters_key, JSON.stringify(filterConditions));
				console.log('âœ… åˆ—ç­›é€‰å™¨å·²ç¼“å­˜:', filterConditions);
			}
		} catch (e) {
			console.error('ç¼“å­˜åˆ—ç­›é€‰å™¨å¤±è´¥:', e);
		}
	}

	// æ¢å¤ Handsontable åˆ—ç­›é€‰å™¨çŠ¶æ€
	restore_column_filters() {
		if (!this.hot) return;

		try {
			const cached = localStorage.getItem(this.cached_filters_key);
			if (cached) {
				const filterConditions = JSON.parse(cached);
				const filtersPlugin = this.hot.getPlugin('filters');

				if (filtersPlugin && filtersPlugin.isEnabled()) {
					// æ¸…é™¤ç°æœ‰ç­›é€‰å™¨
					filtersPlugin.clearConditions();

					// æ¢å¤ç­›é€‰æ¡ä»¶
					filterConditions.forEach(item => {
						item.conditions.forEach(condition => {
							filtersPlugin.addCondition(item.column, condition.name, condition.args);
						});
					});

					// åº”ç”¨ç­›é€‰å™¨
					filtersPlugin.filter();
					console.log('âœ… åˆ—ç­›é€‰å™¨å·²æ¢å¤:', filterConditions);
				}
			}
		} catch (e) {
			console.error('æ¢å¤åˆ—ç­›é€‰å™¨å¤±è´¥:', e);
		}
	}

	// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
	show_loading_state() {
		if (this.hot) {
			this.hot.updateSettings({
				data: [],
				licenseKey: 'non-commercial-and-evaluation'
			});
		}
	}

	// éšè—åŠ è½½çŠ¶æ€
	hide_loading_state() {
		// åŠ è½½å®Œæˆåéšè—åŠ è½½çŠ¶æ€
	}

	// æ˜¾ç¤ºé‡è¯•æŒ‰é’®
	show_retry_button() {
		const retryHtml = `
			<div class="text-center p-4">
				<div class="alert alert-warning">
					<h5>æ•°æ®åŠ è½½å¤±è´¥</h5>
					<p>æ— æ³•è·å–æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
					<button class="btn btn-primary btn-retry-data">
						<i class="fa fa-refresh"></i> é‡è¯•
					</button>
				</div>
			</div>
		`;
		
		// åœ¨è¡¨æ ¼å®¹å™¨ä¸­æ˜¾ç¤ºé‡è¯•æŒ‰é’®
		this.wrapper.find('.handsontable-container').html(retryHtml);
		
		// ç»‘å®šé‡è¯•äº‹ä»¶
		this.wrapper.find('.btn-retry-data').on('click', () => {
			this.fetch_data();
		});
	}

	// å¯¼å‡º Excelï¼ˆæ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶ï¼‰
	export_excel() {
		frappe.call({
			method: "product_sales_planning.planning_system.page.data_view.data_view.export_data_view",
			args: {
				filters: this.filters
			},
			freeze: true,
			freeze_message: "æ­£åœ¨å¯¼å‡º Excel...",
			callback: (r) => {
				if (r.message && r.message.status === "success") {
	}

	// éšè—åŠ è½½çŠ¶æ€
	hide_loading_state() {
		// åŠ è½½å®Œæˆåéšè—åŠ è½½çŠ¶æ€
	}

	// æ˜¾ç¤ºé‡è¯•æŒ‰é’®
	show_retry_button() {
		const retryHtml = `
			<div class="text-center p-4">
				<div class="alert alert-warning">
					<h5>æ•°æ®åŠ è½½å¤±è´¥</h5>
					<p>æ— æ³•è·å–æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
					<button class="btn btn-primary btn-retry-data">
						<i class="fa fa-refresh"></i> é‡è¯•
					</button>
				</div>
			</div>
		`;
		
		// åœ¨è¡¨æ ¼å®¹å™¨ä¸­æ˜¾ç¤ºé‡è¯•æŒ‰é’®
		this.wrapper.find('.handsontable-container').html(retryHtml);
		
		// ç»‘å®šé‡è¯•äº‹ä»¶
		this.wrapper.find('.btn-retry-data').on('click', () => {
			this.fetch_data();
		});
	}

	// å¯¼å‡º Excelï¼ˆæ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶ï¼‰
	export_excel() {
		frappe.call({
			method: "product_sales_planning.planning_system.page.data_view.data_view.export_data_view",
			args: {
				filters: this.filters
			},
			freeze: true,
			freeze_message: "æ­£åœ¨å¯¼å‡º Excel...",
			callback: (r) => {
				if (r.message && r.message.status === "success") {
					window.open(r.message.file_url, '_blank');
					frappe.show_alert({
						message: 'å¯¼å‡ºæˆåŠŸ',
						indicator: 'green'
					}, 3);
				} else {
					frappe.msgprint({
						title: 'å¯¼å‡ºå¤±è´¥',
						message: r.message?.message || 'å¯¼å‡ºå¤±è´¥',
						indicator: 'red'
					});
				}
			},
			error: (err) => {
				console.error('å¯¼å‡ºå¤±è´¥:', err);
				frappe.msgprint('å¯¼å‡ºå¤±è´¥');
			}
		});
	}

	fetch_filter_options() {
		return new Promise((resolve, reject) => {
			frappe.call({
				method: "product_sales_planning.planning_system.page.data_view.data_view.get_data_view_filter_options",
				callback: (r) => {
					if (r.message && r.message.status === "success") {
						this.filter_options = r.message;
						console.log('âœ… ç­›é€‰é€‰é¡¹åŠ è½½æˆåŠŸ');
						resolve();
					} else {
						const errorMsg = r.message?.message || 'åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥';
						console.error('âŒ ç­›é€‰é€‰é¡¹åŠ è½½å¤±è´¥:', errorMsg);
						frappe.show_alert({
							message: `ç­›é€‰é€‰é¡¹åŠ è½½å¤±è´¥: ${errorMsg}`,
							indicator: 'red'
						}, 5);
						
						// è®¾ç½®é»˜è®¤é€‰é¡¹ä½œä¸ºé™çº§æ–¹æ¡ˆ
						this.filter_options = {
							status: "success",
							tasks: [],
							stores: [],
							products: [],
							channels: [],
							approval_statuses: ['å¾…å®¡æ‰¹', 'å·²é€šè¿‡', 'å·²é©³å›'],
							submission_statuses: ['æœªå¼€å§‹', 'å·²æäº¤']
						};
						
						// æ˜¾ç¤ºé™çº§æç¤º
						frappe.show_alert({
							message: 'å·²å¯ç”¨é™çº§æ¨¡å¼ï¼Œéƒ¨åˆ†ç­›é€‰åŠŸèƒ½å¯èƒ½å—é™',
							indicator: 'yellow'
						}, 3);
						
						resolve(); // ä»ç„¶ resolveï¼Œè®©é¡µé¢ç»§ç»­åŠ è½½
					}
				},
				error: (err) => {
					console.error('âŒ ç­›é€‰é€‰é¡¹åŠ è½½å¤±è´¥:', err);
					frappe.show_alert({
						message: `ç½‘ç»œé”™è¯¯: ${err.message || 'æ— æ³•è¿æ¥æœåŠ¡å™¨'}`,
						indicator: 'red'
					}, 5);
					
					// è®¾ç½®é»˜è®¤é€‰é¡¹ä½œä¸ºé™çº§æ–¹æ¡ˆ
					this.filter_options = {
						status: "success",
						tasks: [],
						stores: [],
						products: [],
						channels: [],
						approval_statuses: ['å¾…å®¡æ‰¹', 'å·²é€šè¿‡', 'å·²é©³å›'],
						submission_statuses: ['æœªå¼€å§‹', 'å·²æäº¤']
					};
					
					// æ˜¾ç¤ºé™çº§æç¤º
					frappe.show_alert({
						message: 'å·²å¯ç”¨é™çº§æ¨¡å¼ï¼Œéƒ¨åˆ†ç­›é€‰åŠŸèƒ½å¯èƒ½å—é™',
						indicator: 'yellow'
					}, 3);
					
					resolve(); // ä»ç„¶ resolveï¼Œè®©é¡µé¢ç»§ç»­åŠ è½½
				}
			});
		});
	}

	update_filter_options() {
		// MultiSelectPills ç±»å‹çš„ç­›é€‰å™¨é€šè¿‡ get_data å‡½æ•°åŠ¨æ€è·å–æ•°æ®
		// ä¸éœ€è¦æ‰‹åŠ¨æ›´æ–°é€‰é¡¹ï¼Œåªéœ€è¦åˆ·æ–°å³å¯
		if (!this.filter_group) return;

		const f = this.filter_group.fields_dict;

		// åˆ·æ–°ç­›é€‰å™¨ä»¥é‡æ–°åŠ è½½æ•°æ®
		if (f.task_ids) f.task_ids.refresh();
		if (f.store_ids) f.store_ids.refresh();
		if (f.product_codes) f.product_codes.refresh();
		if (f.channels) f.channels.refresh();
	}

	on_filter_change() {
		// ç­›é€‰å™¨å˜åŒ–æ—¶ä¸è‡ªåŠ¨åˆ·æ–°ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®
	}

	clear_filters() {
		if (this.filter_group) {
			this.filter_group.set_values({
				task_ids: '',
				store_ids: '',
				product_codes: '',
				channels: '',
				approval_statuses: '',
				submission_statuses: ''
			});
		}
		this.filters = {};
		this.current_page = 1;
		this.fetch_data();
	}

	apply_filters() {
		const values = this.filter_group.get_values();
		this.filters = {};

		// è¾…åŠ©å‡½æ•°ï¼šä»æ˜¾ç¤ºæ–‡æœ¬ä¸­æå– ID
		const extractId = (displayText) => {
			if (!displayText || displayText.trim() === '') return null;

			// ä» "åç§° (ID)" æ ¼å¼ä¸­æå– ID
			const match = displayText.match(/\(([^)]+)\)$/);
			return match ? match[1] : displayText;
		};

		// ä»»åŠ¡ç­›é€‰ï¼šAutocomplete è¿”å›å•ä¸ªå­—ç¬¦ä¸²
		if (values.task_ids && values.task_ids.trim() !== '') {
			const taskId = extractId(values.task_ids);
			if (taskId) {
				this.filters.task_ids = [taskId];
			}
		}

		// åº—é“ºç­›é€‰ï¼šAutocomplete è¿”å›å•ä¸ªå­—ç¬¦ä¸²
		if (values.store_ids && values.store_ids.trim() !== '') {
			const storeId = extractId(values.store_ids);
			if (storeId) {
				this.filters.store_ids = [storeId];
			}
		}

		// å•†å“ç­›é€‰ï¼šAutocomplete è¿”å›å•ä¸ªå­—ç¬¦ä¸²
		if (values.product_codes && values.product_codes.trim() !== '') {
			const productCode = extractId(values.product_codes);
			if (productCode) {
				this.filters.product_codes = [productCode];
			}
		}

		// æ¸ é“ç­›é€‰ï¼šAutocomplete è¿”å›å•ä¸ªå­—ç¬¦ä¸²
		if (values.channels && values.channels.trim() !== '') {
			this.filters.channels = [values.channels.trim()];
		}

		// å…¶ä»–ç­›é€‰å™¨ç›´æ¥ä½¿ç”¨
		if (values.approval_statuses) this.filters.approval_statuses = values.approval_statuses;
		if (values.submission_statuses) this.filters.submission_statuses = values.submission_statuses;

		// ç¼“å­˜ç­›é€‰å™¨çŠ¶æ€åˆ° localStorage
		this.cache_filters(values);

		this.current_page = 1;
		this.fetch_data();
	}

	// ç¼“å­˜ç­›é€‰å™¨çŠ¶æ€
	cache_filters(values) {
		try {
			localStorage.setItem('data_view_filters', JSON.stringify(values));
			console.log('âœ… ç­›é€‰å™¨å·²ç¼“å­˜');
		} catch (e) {
			console.error('ç¼“å­˜ç­›é€‰å™¨å¤±è´¥:', e);
		}
	}

	// åŠ è½½ç¼“å­˜çš„ç­›é€‰å™¨
	load_cached_filters() {
		try {
			const cached = localStorage.getItem('data_view_filters');
			if (cached) {
				const values = JSON.parse(cached);
				console.log('âœ… åŠ è½½ç¼“å­˜çš„ç­›é€‰å™¨:', values);

				// å»¶è¿Ÿè®¾ç½®ï¼Œç¡®ä¿ç­›é€‰å™¨å·²åˆå§‹åŒ–
				setTimeout(() => {
					if (this.filter_group && this.filter_group.fields_dict) {
						try {
							this.filter_group.set_values(values);
							console.log('âœ… ç­›é€‰å™¨å€¼å·²æ¢å¤');
						} catch (e) {
							console.error('âŒ æ¢å¤ç­›é€‰å™¨å€¼å¤±è´¥:', e);
							// æ¸…é™¤æ— æ•ˆçš„ç¼“å­˜
							localStorage.removeItem('data_view_filters');
						}
					}
				}, 500);
			}
		} catch (e) {
			console.error('âŒ åŠ è½½ç¼“å­˜ç­›é€‰å™¨å¤±è´¥:', e);
			// æ¸…é™¤æ— æ•ˆçš„ç¼“å­˜
			localStorage.removeItem('data_view_filters');
		}
	}

	fetch_data() {
		const self = this;

		console.log('ğŸ” å¼€å§‹åŠ è½½æ•°æ®ï¼Œç­›é€‰æ¡ä»¶:', this.filters);

		// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
		this.show_loading_state();

		frappe.call({
			method: "product_sales_planning.planning_system.page.data_view.data_view.get_data_view",
			args: {
				filters: this.filters,
				page: this.current_page,
				page_size: this.page_size
			},
			freeze: true,
			freeze_message: "åŠ è½½æ•°æ®...",
			callback: (r) => {
				console.log('ğŸ“¦ API å“åº”:', r);
				if (r.message && r.message.status === "success") {
					console.log('âœ… æ•°æ®åŠ è½½æˆåŠŸï¼Œè®°å½•æ•°:', r.message.total);
					self.data = r.message;
					self.render();
					self.hide_loading_state();
				} else {
					const errorMsg = r.message?.message || 'æ•°æ®åŠ è½½å¤±è´¥';
					console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', errorMsg);
					
					frappe.show_alert({
						message: `æ•°æ®åŠ è½½å¤±è´¥: ${errorMsg}`,
						indicator: 'red'
					}, 5);
					
					// æ˜¾ç¤ºç©ºæ•°æ®
					self.data = { data: [], total: 0, stats: {} };
					self.render();
					self.hide_loading_state();
					
					// æ˜¾ç¤ºé‡è¯•æŒ‰é’®
					self.show_retry_button();
				}
			},
			error: (err) => {
				console.error('âŒ ç½‘ç»œé”™è¯¯:', err);
				
				frappe.show_alert({
					message: `ç½‘ç»œé”™è¯¯: ${err.message || 'æ— æ³•è¿æ¥æœåŠ¡å™¨'}`,
					indicator: 'red'
				}, 5);
				
				// æ˜¾ç¤ºç©ºæ•°æ®
				self.data = { data: [], total: 0, stats: {} };
				self.render();
				self.hide_loading_state();
				
				// æ˜¾ç¤ºé‡è¯•æŒ‰é’®
				self.show_retry_button();
			}
		});
	}

	render() {
		console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“æ•°æ®:', this.data);

		// æ›´æ–°ç»Ÿè®¡å¡ç‰‡
		this.wrapper.find('#stat-total-stores').text(this.data.stats.total_stores || 0);
		this.wrapper.find('#stat-total-products').text(this.data.stats.total_products || 0);
		this.wrapper.find('#stat-total-quantity').text(this.data.stats.total_quantity || 0);
		this.wrapper.find('#stat-completed-stores').text(this.data.stats.completed_stores || 0);
		this.wrapper.find('#stat-pending-stores').text(this.data.stats.pending_stores || 0);
		this.wrapper.find('#stat-rejected-stores').text(this.data.stats.rejected_stores || 0);

		// æ›´æ–°åˆ†é¡µä¿¡æ¯
		const totalPages = Math.ceil(this.data.total / this.page_size) || 1;
		this.wrapper.find('#total-records').text(this.data.total || 0);
		this.wrapper.find('#current-page').text(this.current_page);
		this.wrapper.find('#total-pages').text(totalPages);

		// æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
		this.wrapper.find('.btn-first-page').prop('disabled', this.current_page === 1);
		this.wrapper.find('.btn-prev-page').prop('disabled', this.current_page === 1);
		this.wrapper.find('.btn-next-page').prop('disabled', this.current_page >= totalPages);
		this.wrapper.find('.btn-last-page').prop('disabled', this.current_page >= totalPages);

		// æ›´æ–° Handsontable æ•°æ®
		if (this.hot) {
			console.log('ğŸ“Š åŠ è½½æ•°æ®åˆ°è¡¨æ ¼ï¼Œæ•°æ®æ¡æ•°:', this.data.data?.length || 0);
			this.hot.loadData(this.data.data || []);
			console.log('âœ… è¡¨æ ¼æ•°æ®åŠ è½½å®Œæˆ');
		} else {
			console.error('âŒ Handsontable å®ä¾‹ä¸å­˜åœ¨');
		}
	}

	goto_page(page) {
		const totalPages = Math.ceil(this.data.total / this.page_size) || 1;

		// éªŒè¯é¡µç 
		if (page < 1) {
			page = 1;
		} else if (page > totalPages) {
			page = totalPages;
		}

		if (page === this.current_page) {
			return;
		}

		this.current_page = page;
		this.fetch_data();
	}

	export_data() {
		frappe.call({
			method: "product_sales_planning.planning_system.page.data_view.data_view.export_data_view",
			args: {
				filters: this.filters
			},
			freeze: true,
			freeze_message: "æ­£åœ¨å¯¼å‡º...",
			callback: (r) => {
				if (r.message && r.message.status === "success") {
					window.open(r.message.file_url, '_blank');
					frappe.show_alert({
						message: 'å¯¼å‡ºæˆåŠŸ',
						indicator: 'green'
					}, 3);
				} else {
					frappe.msgprint({
						title: 'å¯¼å‡ºå¤±è´¥',
						message: r.message?.message || 'å¯¼å‡ºå¤±è´¥',
						indicator: 'red'
					});
				}
			},
			error: (err) => {
				console.error('å¯¼å‡ºå¤±è´¥:', err);
				frappe.msgprint('å¯¼å‡ºå¤±è´¥');
			}
		});
	}

	export_csv() {
		if (this.hot) {
			const exportPlugin = this.hot.getPlugin('exportFile');
			exportPlugin.downloadFile('csv', {
				filename: `æ•°æ®æŸ¥çœ‹_${frappe.datetime.now_datetime()}`,
				columnHeaders: true
			});
			frappe.show_alert({
				message: 'CSV å¯¼å‡ºæˆåŠŸ',
				indicator: 'green'
			}, 3);
		}
	}

	// åˆå§‹åŒ–åˆ—è®¾ç½®å¤é€‰æ¡†ï¼ˆé¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰
	init_column_checkboxes() {
		if (!this.hot) return;

		const $checkboxArea = this.wrapper.find('#column-checkboxes');
		const hiddenColumnsPlugin = this.hot.getPlugin('hiddenColumns');
		const allColumns = this.hot.countCols();
		const hiddenColumns = hiddenColumnsPlugin.hiddenColumns || [];

		let html = `
			<div style="margin-bottom: 10px;">
				<label style="cursor: pointer; user-select: none; font-weight: 600;">
					<input type="checkbox" id="select-all-columns-inline" checked style="margin-right: 8px;">
					å…¨é€‰/å–æ¶ˆå…¨é€‰
				</label>
			</div>
			<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
		`;

		for (let i = 0; i < allColumns; i++) {
			const header = this.hot.getColHeader(i);
			const isVisible = !hiddenColumns.includes(i);
			const checked = isVisible ? 'checked' : '';

			html += `
				<label style="cursor: pointer; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; user-select: none; display: flex; align-items: center; background: ${isVisible ? '#fff' : '#f8f9fa'};">
					<input type="checkbox" class="column-checkbox-inline" data-col-index="${i}" ${checked} style="margin-right: 8px;">
					<span style="font-size: 13px;">${header}</span>
				</label>
			`;
		}

		html += '</div>';

		$checkboxArea.html(html);

		// ç»‘å®šå…¨é€‰/å–æ¶ˆå…¨é€‰äº‹ä»¶
		this.wrapper.find('#select-all-columns-inline').on('change', function() {
			const checked = $(this).is(':checked');
			$checkboxArea.find('.column-checkbox-inline').prop('checked', checked).trigger('change');
		});

		// ç»‘å®šå¤é€‰æ¡†å˜åŒ–äº‹ä»¶
		this.wrapper.find('.column-checkbox-inline').on('change', (e) => {
			const $checkbox = $(e.target);
			const colIndex = parseInt($checkbox.data('col-index'));
			const isChecked = $checkbox.is(':checked');

			if (isChecked) {
				hiddenColumnsPlugin.showColumn(colIndex);
			} else {
				hiddenColumnsPlugin.hideColumn(colIndex);
			}
			this.hot.render();

			// æ›´æ–°å¤é€‰æ¡†çš„èƒŒæ™¯è‰²
			$checkbox.closest('label').css('background', isChecked ? '#fff' : '#f8f9fa');
		});
	}

	toggle_column_settings() {
		const $checkboxArea = this.wrapper.find('#column-checkboxes');

		if ($checkboxArea.is(':visible')) {
			$checkboxArea.slideUp(200);
		} else {
			$checkboxArea.slideDown(200);
		}
	}

	show_column_settings() {
		if (!this.hot) return;

		const hiddenColumnsPlugin = this.hot.getPlugin('hiddenColumns');
		const allColumns = this.hot.countCols();
		const hiddenColumns = hiddenColumnsPlugin.hiddenColumns || [];

		// è·å–æ‰€æœ‰åˆ—çš„ä¿¡æ¯
		const columnInfo = [];
		for (let i = 0; i < allColumns; i++) {
			const header = this.hot.getColHeader(i);
			columnInfo.push({
				index: i,
				header: header,
				visible: !hiddenColumns.includes(i)
			});
		}

		// åˆ›å»ºåˆ—è®¾ç½®å¯¹è¯æ¡†
		const dialog = new frappe.ui.Dialog({
			title: 'åˆ—è®¾ç½®',
			fields: [
				{
					fieldtype: 'HTML',
					fieldname: 'column_list',
					options: this.render_column_list(columnInfo)
				}
			],
			primary_action_label: 'åº”ç”¨',
			primary_action: () => {
				// è·å–æ‰€æœ‰å¤é€‰æ¡†çš„çŠ¶æ€
				const checkboxes = dialog.$wrapper.find('.column-checkbox');
				const columnsToHide = [];
				const columnsToShow = [];

				checkboxes.each(function() {
					const colIndex = parseInt($(this).data('col-index'));
					if ($(this).is(':checked')) {
						columnsToShow.push(colIndex);
					} else {
						columnsToHide.push(colIndex);
					}
				});

				// åº”ç”¨åˆ—çš„æ˜¾ç¤º/éšè—
				hiddenColumnsPlugin.hideColumns(columnsToHide);
				hiddenColumnsPlugin.showColumns(columnsToShow);
				this.hot.render();

				frappe.show_alert({
					message: 'åˆ—è®¾ç½®å·²åº”ç”¨',
					indicator: 'green'
				}, 2);

				dialog.hide();
			}
		});

		dialog.show();

		// ç»‘å®šå…¨é€‰/å–æ¶ˆå…¨é€‰äº‹ä»¶
		dialog.$wrapper.find('#select-all-columns').on('change', function() {
			const checked = $(this).is(':checked');
			dialog.$wrapper.find('.column-checkbox').prop('checked', checked);
		});
	}

	render_column_list(columnInfo) {
		let html = `
			<div style="max-height: 400px; overflow-y: auto;">
				<div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
					<label style="cursor: pointer; user-select: none;">
						<input type="checkbox" id="select-all-columns" checked style="margin-right: 8px;">
						<strong>å…¨é€‰/å–æ¶ˆå…¨é€‰</strong>
					</label>
				</div>
				<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
		`;

		columnInfo.forEach(col => {
			const checked = col.visible ? 'checked' : '';
			html += `
				<label style="cursor: pointer; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; user-select: none; display: flex; align-items: center;">
					<input type="checkbox" class="column-checkbox" data-col-index="${col.index}" ${checked} style="margin-right: 8px;">
					<span>${col.header}</span>
				</label>
			`;
		});

		html += `
				</div>
			</div>
		`;

		return html;
	}
}
