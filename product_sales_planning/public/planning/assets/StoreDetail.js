var ne=Object.defineProperty;var ee=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var te=(r,d,t)=>d in r?ne(r,d,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[d]=t,O=(r,d)=>{for(var t in d||(d={}))re.call(d,t)&&te(r,t,d[t]);if(ee)for(var t of ee(d))ie.call(d,t)&&te(r,t,d[t]);return r};var M=(r,d,t)=>new Promise((m,y)=>{var i=a=>{try{b(t.next(a))}catch(x){y(x)}},C=a=>{try{b(t.throw(a))}catch(x){y(x)}},b=a=>a.done?m(a.value):Promise.resolve(a.value).then(i,C);b((t=t.apply(r,d)).next())});import{r as S,c as de,a as k,b as R,o as se,d as ue,w as A,_ as L,e as f,f as p,g as e,t as _,h as N,v as oe,i as Y,F as U,j as q,n as Z,k as D,l as Q,m as ce,u as ge,p as J,q as $}from"./index.js";function me(r,d){const t=S({search:"",mechanism:"",category:""}),m=S({currentPage:1,pageSize:50,pageSizeOptions:[20,50,100,200]}),y=S({hiddenColumns:[]}),i=de({url:"product_sales_planning.planning_system.page.store_detail.store_detail.get_store_commodity_data",params:()=>({store_id:r,task_id:d,view_mode:"multi",start:(m.value.currentPage-1)*m.value.pageSize,page_length:m.value.pageSize,search_term:t.value.search||null,brand:t.value.brand||null,category:t.value.category||null}),auto:!0,transform:s=>(console.log("API 返回的原始数据:",s),s?{commodities:s.data||[],months:s.months||[],store_info:s.store_info||{},task_info:s.task_info||{},can_edit:s.can_edit!==void 0?s.can_edit:!0,edit_reason:s.edit_reason||"",approval_status:s.approval_status||{},total_count:s.total_count||0}:{commodities:[],months:[],store_info:{},task_info:{},can_edit:!1,edit_reason:"",approval_status:{},total_count:0})}),C=k(()=>{const s=b.value,o=new Set,l=new Set;return s.forEach(n=>{n.mechanism&&o.add(n.mechanism),n.category&&l.add(n.category)}),{mechanisms:Array.from(o).sort(),categories:Array.from(l).sort()}}),b=k(()=>{var s;return((s=i.data)==null?void 0:s.commodities)||[]}),a=k(()=>{var s;return((s=i.data)==null?void 0:s.months)||[]}),x=k(()=>{var s;return((s=i.data)==null?void 0:s.store_info)||{}}),h=k(()=>{var s;return((s=i.data)==null?void 0:s.task_info)||{}}),u=k(()=>{var s;return((s=i.data)==null?void 0:s.can_edit)||!1}),g=k(()=>{var s;return((s=i.data)==null?void 0:s.approval_status)||{}}),c=k(()=>{var s;return((s=i.data)==null?void 0:s.total_count)||0}),v=k(()=>b.value),I=k(()=>b.value),j=k(()=>Math.ceil(c.value/m.value.pageSize)||1),w=k(()=>{const s=v.value;let o=0;return s.forEach(l=>{l.months&&Object.values(l.months).forEach(n=>{const z=(n==null?void 0:n.quantity)||0;o+=Number(z)})}),{totalSKU:s.length,totalQuantity:o,plannedSKU:s.filter(l=>l.months?Object.values(l.months).some(n=>((n==null?void 0:n.quantity)||0)>0):!1).length}}),H=()=>M(this,null,function*(){yield i.reload()}),B=s=>{t.value=O(O({},t.value),s),m.value.currentPage=1,i.reload()},W=s=>{m.value=O(O({},m.value),s),i.reload()},X=(s,o,l)=>M(this,null,function*(){try{const n=yield R("product_sales_planning.planning_system.page.store_detail.store_detail.update_month_quantity",{store_id:r,task_id:d,code:s,month:o,quantity:l});return n&&n.status==="success"?{success:!0,message:"保存成功"}:{success:!1,message:(n==null?void 0:n.message)||"保存失败"}}catch(n){return console.error("保存失败:",n),{success:!1,message:n.message||"保存失败"}}}),K=s=>M(this,null,function*(){try{const o=s.map(([n,z,P,E])=>{const le=I.value[n],ae=a.value[z-2];return{code:le.commodity_code,month:ae,quantity:E}}),l=yield R("product_sales_planning.planning_system.page.store_detail.store_detail.batch_update_quantities",{store_id:r,task_id:d,updates:JSON.stringify(o)});return l&&l.status==="success"?{success:!0,message:"批量保存成功"}:{success:!1,message:(l==null?void 0:l.message)||"批量保存失败"}}catch(o){return console.error("批量保存失败:",o),{success:!1,message:o.message||"批量保存失败"}}}),T=()=>M(this,null,function*(){try{const s=yield R("product_sales_planning.planning_system.page.store_detail.store_detail.export_commodity_data",{store_id:r,task_id:d});return s&&s.status==="success"?(window.open(s.file_url,"_blank"),{success:!0,message:`成功导出 ${s.record_count} 条记录`}):{success:!1,message:(s==null?void 0:s.message)||"导出失败"}}catch(s){return console.error("导出失败:",s),{success:!1,message:s.message||"导出失败"}}}),F=()=>{const s=[{data:"code",title:"商品编码",readOnly:!0,width:120},{data:"name1",title:"商品名称",readOnly:!0,width:200}];return a.value.forEach(o=>{s.push({data:o,title:o,type:"numeric",readOnly:!u.value,width:100,numericFormat:{pattern:"0,0"}})}),s},V=()=>{const s=["商品编码","商品名称"];return a.value.forEach(o=>{s.push(o)}),s},G=()=>I.value.map(s=>{const o={code:s.commodity_code||s.code,name1:s.commodity_name||s.name1};return a.value.forEach(l=>{var z;const n=(z=s.months)==null?void 0:z[l];o[l]=(n==null?void 0:n.quantity)||0}),o});return{filters:t,pagination:m,columnSettings:y,rawCommodities:b,filteredCommodities:v,paginatedCommodities:I,months:a,storeInfo:x,taskInfo:h,canEdit:u,approvalStatus:g,statistics:w,totalPages:j,totalCount:c,loading:k(()=>i.loading),error:k(()=>i.error),filterOptions:C,refreshData:H,updateFilters:B,updatePagination:W,saveMonthQuantity:X,batchSaveChanges:K,exportToExcel:T,generateColumns:F,generateHeaders:V,transformDataForTable:G}}function ve(){return new Promise((r,d)=>{if(window.Handsontable){console.log("✅ Handsontable already loaded"),r();return}const t=(y,i)=>new Promise((C,b)=>{if(document.getElementById(y)){C();return}const a=document.createElement("link");a.id=y,a.rel="stylesheet",a.href=i,a.onload=()=>{console.log(`✅ CSS loaded: ${i}`),C()},a.onerror=()=>b(new Error(`Failed to load CSS: ${i}`)),document.head.appendChild(a)}),m=y=>new Promise((i,C)=>{if(window.Handsontable){i();return}const b=document.createElement("script");b.src=y,b.onload=()=>{console.log(`✅ JS loaded: ${y}`),i()},b.onerror=()=>C(new Error(`Failed to load JS: ${y}`)),document.head.appendChild(b)});Promise.resolve().then(()=>t("handsontable-css","/assets/product_sales_planning/js/lib/handsontable.full.min.css")).then(()=>m("/assets/product_sales_planning/js/lib/handsontable.full.min.js")).then(()=>{console.log("✅ All Handsontable resources loaded"),r()}).catch(d),setTimeout(()=>{d(new Error("Handsontable 资源加载超时，请检查网络或刷新页面"))},1e4)})}function fe(r,d={}){const t=S(null),m=S(!0),y=S(null),i=S(!1),C=()=>M(this,null,function*(){try{if(m.value=!0,y.value=null,yield ve(),!r.value)throw new Error("Container element not found");if(!r.value.parentNode)throw new Error("Container element not mounted to DOM");if(!window.Handsontable)throw new Error("Handsontable library not loaded");if(t.value&&!i.value)try{t.value.destroy(),t.value=null,console.log("✅ Old Handsontable instance destroyed")}catch(j){console.warn("⚠️ Failed to destroy old instance:",j)}const v=j=>j&&typeof j=="object"&&"value"in j?j.value:j,I=O({data:v(d.data)||[],columns:v(d.columns)||[],colHeaders:v(d.colHeaders)!==!1,rowHeaders:v(d.rowHeaders)!==!1,fixedColumnsLeft:d.fixedColumnsLeft||2,licenseKey:"non-commercial-and-evaluation",stretchH:"all",autoWrapRow:!1,autoWrapCol:!1,manualColumnResize:!0,manualRowResize:!0,contextMenu:d.contextMenu!==!1,dropdownMenu:d.dropdownMenu||!1,filters:d.filters||!1,columnSorting:d.columnSorting||!1,renderAllRows:!1,viewportRowRenderingOffset:30,viewportColumnRenderingOffset:10,afterChange:(j,w)=>{w!=="loadData"&&d.onDataChange&&d.onDataChange(j,w)},afterSelection:(j,w,H,B)=>{d.onSelection&&d.onSelection(j,w,H,B)}},d.config?Object.keys(d.config).reduce((j,w)=>(j[w]=v(d.config[w]),j),{}):{});t.value=new window.Handsontable(r.value,I),i.value=!1,console.log("✅ Handsontable initialized successfully"),m.value=!1}catch(v){console.error("❌ Handsontable initialization error:",v),y.value=v.message,m.value=!1}}),b=v=>{t.value&&!i.value&&t.value.loadData(v)},a=v=>{t.value&&!i.value&&t.value.updateSettings({columns:v})},x=()=>t.value&&!i.value?t.value.getData():[],h=(v,I)=>t.value&&!i.value?t.value.getDataAtCell(v,I):null,u=(v,I,j)=>{t.value&&!i.value&&t.value.setDataAtCell(v,I,j)},g=()=>{t.value&&!i.value&&t.value.render()},c=()=>{t.value&&!i.value&&(t.value.destroy(),t.value=null,i.value=!0,console.log("✅ Handsontable destroyed"))};return se(()=>{C()}),ue(()=>{c()}),d.data&&A(()=>d.data,v=>{v&&t.value&&!m.value&&b(v)},{deep:!0}),d.columns&&A(()=>d.columns,v=>{v&&t.value&&!m.value&&a(v)},{deep:!0}),{hotInstance:t,loading:m,error:y,updateData:b,updateColumns:a,getData:x,getDataAtCell:h,setDataAtCell:u,render:g,destroy:c}}const pe={class:"commodity-table-wrapper"},be={key:0,class:"flex items-center justify-center py-12"},ye={key:1,class:"flex items-center justify-center py-12"},he={class:"text-red-500"},xe={key:2,class:"handsontable-container"},_e={__name:"CommodityTable",props:{data:{type:Array,default:()=>[]},columns:{type:Array,default:()=>[]},headers:{type:Array,default:()=>[]},canEdit:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},error:{type:String,default:null}},emits:["dataChange","selection"],setup(r,{expose:d,emit:t}){const m=r,y=t,i=S(null),C=(u,g)=>{console.log("Table data changed:",u,g),y("dataChange",u,g)},b=(u,g,c,v)=>{y("selection",u,g,c,v)},{hotInstance:a,loading:x,updateData:h}=fe(i,{data:k(()=>m.data),columns:k(()=>m.columns),colHeaders:k(()=>m.headers),onDataChange:C,onSelection:b,config:{readOnly:k(()=>!m.canEdit)}});return A(()=>m.data,u=>{u&&a.value&&!x.value&&h(u)},{deep:!0}),d({hotInstance:a,updateData:h}),(u,g)=>(p(),f("div",pe,[r.loading?(p(),f("div",be,[...g[0]||(g[0]=[e("div",{class:"text-gray-500"},"正在加载表格数据...",-1)])])):r.error?(p(),f("div",ye,[e("div",he,_(r.error),1)])):(p(),f("div",xe,[e("div",{ref_key:"tableContainer",ref:i,class:"w-full"},null,512)]))]))}},we=L(_e,[["__scopeId","data-v-7dbd32f2"]]),ke={class:"filter-panel bg-white rounded-lg shadow p-4 mb-4"},Ce={class:"flex flex-wrap gap-4 items-end"},$e={class:"flex-1 min-w-[200px]"},Se={class:"w-48"},Pe=["value"],je={class:"w-48"},Ie=["value"],ze={__name:"FilterPanel",props:{filters:{type:Object,default:()=>({search:"",mechanism:"",category:""})},filterOptions:{type:Object,default:()=>({mechanisms:[],categories:[]})}},emits:["update:filters"],setup(r,{emit:d}){const t=r,m=d,y=S(O({},t.filters));A(()=>t.filters,b=>{y.value=O({},b)},{deep:!0});const i=()=>{m("update:filters",O({},y.value))},C=()=>{y.value={search:"",mechanism:"",category:""},i()};return(b,a)=>(p(),f("div",ke,[e("div",Ce,[e("div",$e,[a[3]||(a[3]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," 搜索商品 ",-1)),N(e("input",{"onUpdate:modelValue":a[0]||(a[0]=x=>y.value.search=x),type:"text",placeholder:"输入商品编码或名称...",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",onInput:i},null,544),[[oe,y.value.search]])]),e("div",Se,[a[5]||(a[5]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," 机制 ",-1)),N(e("select",{"onUpdate:modelValue":a[1]||(a[1]=x=>y.value.mechanism=x),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",onChange:i},[a[4]||(a[4]=e("option",{value:""},"全部",-1)),(p(!0),f(U,null,q(r.filterOptions.mechanisms,x=>(p(),f("option",{key:x,value:x},_(x),9,Pe))),128))],544),[[Y,y.value.mechanism]])]),e("div",je,[a[7]||(a[7]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," 分类 ",-1)),N(e("select",{"onUpdate:modelValue":a[2]||(a[2]=x=>y.value.category=x),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",onChange:i},[a[6]||(a[6]=e("option",{value:""},"全部",-1)),(p(!0),f(U,null,q(r.filterOptions.categories,x=>(p(),f("option",{key:x,value:x},_(x),9,Ie))),128))],544),[[Y,y.value.category]])]),e("div",null,[e("button",{onClick:C,class:"px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors"}," 重置 ")])])]))}},Me=L(ze,[["__scopeId","data-v-4dd1893c"]]),Ee={class:"stats-cards grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"},De={class:"stat-card bg-white rounded-lg shadow p-4"},He={class:"flex items-center justify-between"},Be={class:"text-2xl font-bold text-gray-900"},Oe={class:"stat-card bg-white rounded-lg shadow p-4"},Ae={class:"flex items-center justify-between"},Ue={class:"text-2xl font-bold text-green-600"},Te={class:"stat-card bg-white rounded-lg shadow p-4"},Fe={class:"flex items-center justify-between"},Ve={class:"text-2xl font-bold text-purple-600"},qe={__name:"StatsCards",props:{statistics:{type:Object,default:()=>({totalSKU:0,plannedSKU:0,totalQuantity:0})}},setup(r){const d=t=>t?t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):"0";return(t,m)=>(p(),f("div",Ee,[e("div",De,[e("div",He,[e("div",null,[m[0]||(m[0]=e("div",{class:"text-sm text-gray-500 mb-1"},"总 SKU 数",-1)),e("div",Be,_(r.statistics.totalSKU),1)]),m[1]||(m[1]=e("div",{class:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center"},[e("svg",{class:"w-6 h-6 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"})])],-1))])]),e("div",Oe,[e("div",Ae,[e("div",null,[m[2]||(m[2]=e("div",{class:"text-sm text-gray-500 mb-1"},"已规划 SKU",-1)),e("div",Ue,_(r.statistics.plannedSKU),1)]),m[3]||(m[3]=e("div",{class:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center"},[e("svg",{class:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1))])]),e("div",Te,[e("div",Fe,[e("div",null,[m[4]||(m[4]=e("div",{class:"text-sm text-gray-500 mb-1"},"总计划量",-1)),e("div",Ve,_(d(r.statistics.totalQuantity)),1)]),m[5]||(m[5]=e("div",{class:"w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center"},[e("svg",{class:"w-6 h-6 text-purple-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"})])],-1))])])]))}},Re=L(qe,[["__scopeId","data-v-57b36da1"]]),Ne={class:"pagination-controls bg-white rounded-lg shadow p-4 flex items-center justify-between"},Le={class:"flex items-center gap-2"},Ke=["value"],Je={class:"text-sm text-gray-600"},Qe={class:"flex items-center gap-2"},We=["disabled"],Xe=["disabled"],Ge={class:"flex items-center gap-1"},Ye=["onClick"],Ze={key:1,class:"px-2 text-gray-500"},et=["disabled"],tt=["disabled"],st={__name:"PaginationControls",props:{currentPage:{type:Number,default:1},pageSize:{type:Number,default:50},totalItems:{type:Number,default:0},totalPages:{type:Number,default:1},pageSizeOptions:{type:Array,default:()=>[20,50,100,200]}},emits:["update:currentPage","update:pageSize"],setup(r,{emit:d}){const t=r,m=d,y=S(t.pageSize),i=k(()=>(t.currentPage-1)*t.pageSize+1),C=k(()=>{const h=t.currentPage*t.pageSize;return h>t.totalItems?t.totalItems:h}),b=k(()=>{const h=[],u=t.totalPages,g=t.currentPage;if(u<=7)for(let c=1;c<=u;c++)h.push(c);else if(g<=4){for(let c=1;c<=5;c++)h.push(c);h.push("..."),h.push(u)}else if(g>=u-3){h.push(1),h.push("...");for(let c=u-4;c<=u;c++)h.push(c)}else{h.push(1),h.push("...");for(let c=g-1;c<=g+1;c++)h.push(c);h.push("..."),h.push(u)}return h}),a=h=>{h>=1&&h<=t.totalPages&&h!==t.currentPage&&m("update:currentPage",h)},x=()=>{m("update:pageSize",y.value),m("update:currentPage",1)};return A(()=>t.pageSize,h=>{y.value=h}),(h,u)=>(p(),f("div",Ne,[e("div",Le,[u[5]||(u[5]=e("span",{class:"text-sm text-gray-600"},"每页显示",-1)),N(e("select",{"onUpdate:modelValue":u[0]||(u[0]=g=>y.value=g),onChange:x,class:"px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"},[(p(!0),f(U,null,q(r.pageSizeOptions,g=>(p(),f("option",{key:g,value:g},_(g),9,Ke))),128))],544),[[Y,y.value]]),u[6]||(u[6]=e("span",{class:"text-sm text-gray-600"},"条",-1))]),e("div",Je," 显示 "+_(i.value)+" - "+_(C.value)+" 条，共 "+_(r.totalItems)+" 条 ",1),e("div",Qe,[e("button",{onClick:u[1]||(u[1]=g=>a(1)),disabled:r.currentPage===1,class:"px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"首页"},[...u[7]||(u[7]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 19l-7-7 7-7m8 14l-7-7 7-7"})],-1)])],8,We),e("button",{onClick:u[2]||(u[2]=g=>a(r.currentPage-1)),disabled:r.currentPage===1,class:"px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"上一页"},[...u[8]||(u[8]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])],8,Xe),e("div",Ge,[(p(!0),f(U,null,q(b.value,g=>(p(),f(U,{key:g},[g!=="..."?(p(),f("button",{key:0,onClick:c=>a(g),class:Z(["px-3 py-1 border rounded-md",g===r.currentPage?"bg-blue-500 text-white border-blue-500":"border-gray-300 hover:bg-gray-50"])},_(g),11,Ye)):(p(),f("span",Ze,"..."))],64))),128))]),e("button",{onClick:u[3]||(u[3]=g=>a(r.currentPage+1)),disabled:r.currentPage===r.totalPages,class:"px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"下一页"},[...u[9]||(u[9]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])],8,et),e("button",{onClick:u[4]||(u[4]=g=>a(r.totalPages)),disabled:r.currentPage===r.totalPages,class:"px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"末页"},[...u[10]||(u[10]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 5l7 7-7 7M5 5l7 7-7 7"})],-1)])],8,tt)])]))}},ot=L(st,[["__scopeId","data-v-5e3a3c82"]]),lt={key:0,class:"fixed inset-0 z-50 overflow-y-auto"},at={class:"flex min-h-full items-center justify-center p-4"},nt={class:"relative bg-white rounded-lg shadow-xl max-w-2xl w-full"},rt={class:"p-6 space-y-4"},it={class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},dt=["disabled"],ut={key:0},ct={key:1},gt={class:"flex items-center gap-3"},mt={key:0,class:"mt-2 text-sm text-gray-600"},vt={key:0,class:"mt-4"},ft={key:0,class:"mt-3"},pt={class:"text-sm text-red-800 space-y-1 max-h-40 overflow-y-auto"},bt={class:"flex items-center justify-end gap-3 p-6 border-t bg-gray-50"},yt=["disabled"],ht={key:0},xt={key:1},_t={__name:"ProductImportDialog",props:{show:{type:Boolean,default:!1},storeId:{type:String,required:!0},taskId:{type:String,required:!0}},emits:["close","success"],setup(r,{emit:d}){const t=r,m=d,y=S(null),i=S(null),C=S(!1),b=S(!1),a=S(null),x=c=>{const v=c.target.files[0];v&&(i.value=v,a.value=null)},h=()=>M(this,null,function*(){b.value=!0;try{const c=yield R("product_sales_planning.planning_system.page.store_detail.store_detail.download_import_template");c&&c.status==="success"?window.open(c.file_url,"_blank"):alert((c==null?void 0:c.msg)||"模板生成失败")}catch(c){console.error("下载模板失败:",c),alert("模板生成失败："+c.message)}finally{b.value=!1}}),u=()=>M(this,null,function*(){if(!i.value){alert("请选择Excel文件");return}C.value=!0,a.value=null;try{const c=new FormData;c.append("file",i.value),c.append("is_private",1),c.append("folder","Home");const I=yield(yield fetch("/api/method/upload_file",{method:"POST",headers:{"X-Frappe-CSRF-Token":window.csrf_token},body:c})).json();if(!I.message||!I.message.file_url)throw new Error("文件上传失败");const j=I.message.file_url,w=yield R("product_sales_planning.planning_system.page.store_detail.store_detail.import_commodity_data",{store_id:t.storeId,task_id:t.taskId,file_url:j});w&&w.status==="success"?(a.value={success:!0,message:w.msg||"导入成功",errors:w.errors||[]},setTimeout(()=>{m("success"),g()},2e3)):a.value={success:!1,message:(w==null?void 0:w.msg)||"导入失败",errors:(w==null?void 0:w.errors)||[]}}catch(c){console.error("导入失败:",c),a.value={success:!1,message:"导入失败："+c.message,errors:[]}}finally{C.value=!1}}),g=()=>{C.value||(i.value=null,a.value=null,y.value&&(y.value.value=""),m("close"))};return(c,v)=>r.show?(p(),f("div",lt,[e("div",{class:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:g}),e("div",at,[e("div",nt,[e("div",{class:"flex items-center justify-between p-6 border-b"},[v[1]||(v[1]=e("h3",{class:"text-lg font-semibold text-gray-900"},"单品导入",-1)),e("button",{onClick:g,class:"text-gray-400 hover:text-gray-500 transition-colors"},[...v[0]||(v[0]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("div",rt,[e("div",it,[v[3]||(v[3]=e("h4",{class:"font-medium text-blue-900 mb-2"},"Excel格式要求：",-1)),v[4]||(v[4]=e("ul",{class:"text-sm text-blue-800 space-y-1"},[e("li",null,"• 第一行：表头（产品编码 | 产品名称 | 2025-01 | 2025-02 | ...）"),e("li",null,"• 数据行：产品编码 | 产品名称 | 数量1 | 数量2 | ..."),e("li",null,"• 月份格式支持：2025-01、202501、2025/01"),e("li",null,"• 空值或0将被跳过")],-1)),e("button",{onClick:h,disabled:b.value,class:"mt-3 px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[b.value?(p(),f("span",ut,"正在生成模板...")):(p(),f("span",ct,[...v[2]||(v[2]=[e("svg",{class:"w-4 h-4 inline-block mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})],-1),Q(" 下载导入模板 ",-1)])]))],8,dt)]),e("div",null,[v[5]||(v[5]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[Q(" 选择Excel文件 "),e("span",{class:"text-red-500"},"*")],-1)),e("div",gt,[e("input",{ref_key:"fileInput",ref:y,type:"file",accept:".xlsx,.xls",onChange:x,class:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"},null,544)]),i.value?(p(),f("p",mt," 已选择："+_(i.value.name),1)):D("",!0)]),a.value?(p(),f("div",vt,[e("div",{class:Z(["rounded-lg p-4",a.value.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"])},[e("h4",{class:Z(["font-medium mb-2",a.value.success?"text-green-900":"text-red-900"])},_(a.value.success?"导入成功":"导入失败"),3),e("p",{class:Z(["text-sm",a.value.success?"text-green-800":"text-red-800"])},_(a.value.message),3),a.value.errors&&a.value.errors.length>0?(p(),f("div",ft,[v[6]||(v[6]=e("p",{class:"text-sm font-medium text-red-900 mb-1"},"错误详情：",-1)),e("ul",pt,[(p(!0),f(U,null,q(a.value.errors,(I,j)=>(p(),f("li",{key:j}," • "+_(I),1))),128))])])):D("",!0)],2)])):D("",!0)]),e("div",bt,[e("button",{onClick:g,class:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"}," 取消 "),e("button",{onClick:u,disabled:!i.value||C.value,class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[C.value?(p(),f("span",ht,"正在导入...")):(p(),f("span",xt,"开始导入"))],8,yt)])])])])):D("",!0)}},wt=L(_t,[["__scopeId","data-v-49cff094"]]),kt={key:0,class:"fixed inset-0 z-[9999] overflow-y-auto"},Ct={class:"flex min-h-full items-center justify-center p-4"},$t={class:"relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col"},St={class:"p-6 border-b flex-shrink-0"},Pt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},jt=["value"],It=["value"],zt={class:"flex-1 overflow-y-auto p-6"},Mt={key:0,class:"flex items-center justify-center py-12"},Et={key:1,class:"text-center py-12 text-gray-500"},Dt={key:2,class:"space-y-2"},Ht={class:"flex items-center p-3 bg-gray-50 rounded-md"},Bt=["checked"],Ot={class:"ml-3 text-sm font-medium text-gray-700"},At=["onClick"],Ut=["checked","onChange"],Tt={class:"ml-3 flex-1"},Ft={class:"text-sm font-medium text-gray-900"},Vt={class:"text-xs text-gray-500 mt-1"},qt={key:0},Rt={key:1,class:"ml-3"},Nt={key:2,class:"ml-3"},Lt={key:3,class:"mt-4 flex items-center justify-between"},Kt={class:"text-sm text-gray-600"},Jt={class:"flex items-center gap-2"},Qt=["disabled"],Wt={class:"text-sm text-gray-600"},Xt=["disabled"],Gt={class:"flex items-center justify-end gap-3 p-6 border-t bg-gray-50 flex-shrink-0"},Yt=["disabled"],Zt={key:0},es={key:1},ts={__name:"ProductAddDialog",props:{show:{type:Boolean,default:!1},storeId:{type:String,required:!0},taskId:{type:String,required:!0},existingProducts:{type:Array,default:()=>[]}},emits:["close","success"],setup(r,{emit:d}){const t=r,m=d,y=S(!1),i=S(!1),C=S([]),b=S(new Set),a=S(""),x=S(""),h=S(""),u=S(""),g=S(1),c=S(20),v=S(null),I=k(()=>{const o=new Set;return C.value.forEach(l=>{l.brand&&o.add(l.brand)}),Array.from(o).sort()}),j=k(()=>{const o=new Set;return C.value.forEach(l=>{l.category&&o.add(l.category)}),Array.from(o).sort()});k(()=>new Set(t.existingProducts.map(o=>o.code)));const w=k(()=>{let o=C.value;if(x.value){const l=x.value.toLowerCase();o=o.filter(n=>(n.code||"").toLowerCase().includes(l)||(n.name1||"").toLowerCase().includes(l))}return h.value&&(o=o.filter(l=>l.brand===h.value)),u.value&&(o=o.filter(l=>l.category===u.value)),o});k(()=>w.value.length);const H=k(()=>{const o=(g.value-1)*c.value,l=o+c.value;return w.value.slice(o,l)}),B=k(()=>Math.ceil(w.value.length/c.value)),W=k(()=>(g.value-1)*c.value+1),X=k(()=>{const o=g.value*c.value;return o>w.value.length?w.value.length:o}),K=k(()=>H.value.length>0&&H.value.every(o=>b.value.has(o.code))),T=()=>M(this,null,function*(){y.value=!0;try{const o=yield R("product_sales_planning.planning_system.page.store_detail.store_detail.get_product_list_for_dialog",{store_id:t.storeId,task_id:t.taskId});o&&o.status==="success"?C.value=o.data||[]:(console.error("加载产品失败:",o==null?void 0:o.message),alert("加载产品失败："+((o==null?void 0:o.message)||"未知错误")))}catch(o){console.error("加载产品失败:",o),alert("加载产品失败："+o.message)}finally{y.value=!1}}),F=o=>{b.value.has(o)?b.value.delete(o):b.value.add(o)},V=()=>{K.value?H.value.forEach(o=>{b.value.delete(o.code)}):H.value.forEach(o=>{b.value.add(o.code)})},G=()=>M(this,null,function*(){if(b.value.size===0){alert("请选择要添加的商品");return}i.value=!0;try{const o=Array.from(b.value),l=yield R("product_sales_planning.planning_system.page.store_detail.store_detail.bulk_insert_commodity_schedule",{store_id:t.storeId,task_id:t.taskId,codes:JSON.stringify(o)});l&&l.status==="success"?(alert(`成功添加 ${l.count} 个商品${l.skipped>0?`，跳过 ${l.skipped} 个已存在的商品`:""}`),m("success"),s()):alert((l==null?void 0:l.msg)||(l==null?void 0:l.message)||"添加失败")}catch(o){console.error("添加失败:",o),alert("添加失败："+o.message)}finally{i.value=!1}}),s=()=>{i.value||(b.value.clear(),a.value="",h.value="",u.value="",g.value=1,m("close"))};return A(a,o=>{v.value&&clearTimeout(v.value),v.value=setTimeout(()=>{x.value=o,g.value=1},300)}),A([h,u],()=>{g.value=1}),A(x,()=>{g.value=1}),A(()=>t.show,o=>{o&&T()}),se(()=>{t.show&&T()}),(o,l)=>r.show?(p(),f("div",kt,[e("div",{class:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:s}),e("div",Ct,[e("div",$t,[e("div",{class:"flex items-center justify-between p-6 border-b flex-shrink-0"},[l[6]||(l[6]=e("h3",{class:"text-lg font-semibold text-gray-900"},"添加商品",-1)),e("button",{onClick:s,class:"text-gray-400 hover:text-gray-500 transition-colors"},[...l[5]||(l[5]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("div",St,[e("div",Pt,[e("div",null,[l[7]||(l[7]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"搜索商品",-1)),N(e("input",{"onUpdate:modelValue":l[0]||(l[0]=n=>a.value=n),type:"text",placeholder:"输入商品编码或名称",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"},null,512),[[oe,a.value]])]),e("div",null,[l[9]||(l[9]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"品牌",-1)),N(e("select",{"onUpdate:modelValue":l[1]||(l[1]=n=>h.value=n),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"},[l[8]||(l[8]=e("option",{value:""},"全部品牌",-1)),(p(!0),f(U,null,q(I.value,n=>(p(),f("option",{key:n,value:n},_(n),9,jt))),128))],512),[[Y,h.value]])]),e("div",null,[l[11]||(l[11]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"分类",-1)),N(e("select",{"onUpdate:modelValue":l[2]||(l[2]=n=>u.value=n),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"},[l[10]||(l[10]=e("option",{value:""},"全部分类",-1)),(p(!0),f(U,null,q(j.value,n=>(p(),f("option",{key:n,value:n},_(n),9,It))),128))],512),[[Y,u.value]])])])]),e("div",zt,[y.value?(p(),f("div",Mt,[...l[12]||(l[12]=[e("div",{class:"text-center"},[e("div",{class:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"}),e("div",{class:"mt-2 text-gray-600"},"加载中...")],-1)])])):w.value.length===0?(p(),f("div",Et," 没有找到商品 ")):(p(),f("div",Dt,[e("div",Ht,[e("input",{type:"checkbox",checked:K.value,onChange:V,class:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"},null,40,Bt),e("label",Ot," 全选 (已选择 "+_(b.value.size)+" 个商品) ",1)]),(p(!0),f(U,null,q(H.value,n=>(p(),f("div",{key:n.code,class:"flex items-center p-3 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors cursor-pointer",onClick:z=>F(n.code)},[e("input",{type:"checkbox",checked:b.value.has(n.code),onChange:ce(z=>F(n.code),["stop"]),class:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"},null,40,Ut),e("div",Tt,[e("div",Ft,_(n.code)+" - "+_(n.name1),1),e("div",Vt,[n.specifications?(p(),f("span",qt,"规格: "+_(n.specifications),1)):D("",!0),n.brand?(p(),f("span",Rt,"品牌: "+_(n.brand),1)):D("",!0),n.category?(p(),f("span",Nt,"分类: "+_(n.category),1)):D("",!0)])])],8,At))),128))])),B.value>1?(p(),f("div",Lt,[e("div",Kt," 显示 "+_(W.value)+" - "+_(X.value)+" 条，共 "+_(w.value.length)+" 条 ",1),e("div",Jt,[e("button",{onClick:l[3]||(l[3]=n=>g.value--),disabled:g.value===1,class:"px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"}," 上一页 ",8,Qt),e("span",Wt," 第 "+_(g.value)+" / "+_(B.value)+" 页 ",1),e("button",{onClick:l[4]||(l[4]=n=>g.value++),disabled:g.value===B.value,class:"px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"}," 下一页 ",8,Xt)])])):D("",!0)]),e("div",Gt,[e("button",{onClick:s,class:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"}," 取消 "),e("button",{onClick:G,disabled:b.value.size===0||i.value,class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[i.value?(p(),f("span",Zt,"正在添加...")):(p(),f("span",es,"添加 ("+_(b.value.size)+")",1))],8,Yt)])])])])):D("",!0)}},ss=L(ts,[["__scopeId","data-v-a4d89321"]]),os={class:"store-detail-page min-h-screen bg-gray-50 p-6"},ls={class:"page-header mb-6"},as={class:"flex items-center justify-between"},ns={class:"flex items-center gap-4"},rs={class:"text-2xl font-bold text-gray-900"},is={class:"text-sm text-gray-500 mt-1"},ds={key:0},us={class:"flex items-center gap-2"},cs=["disabled"],gs={key:0},ms={key:1},vs={key:0,class:"flex items-center justify-center py-20"},fs={key:1,class:"bg-red-50 border border-red-200 rounded-lg p-6 text-center"},ps={class:"text-red-600 text-lg font-medium"},bs={key:2,class:"space-y-4"},ys={__name:"StoreDetail",props:{storeId:{type:String,required:!0},taskId:{type:String,required:!0}},setup(r){const d=r,t=ge(),{filters:m,pagination:y,filteredCommodities:i,storeInfo:C,taskInfo:b,canEdit:a,statistics:x,totalPages:h,totalCount:u,loading:g,error:c,filterOptions:v,refreshData:I,updateFilters:j,updatePagination:w,batchSaveChanges:H,exportToExcel:B,generateColumns:W,generateHeaders:X,transformDataForTable:K}=me(d.storeId,d.taskId),T=S(!1),F=S(!1),V=S(!1),G=()=>{t.push("/")},s=()=>M(this,null,function*(){yield I()}),o=(z,P)=>M(this,null,function*(){if(console.log("Data changed:",z,P),z&&z.length>0){const E=yield H(z);E.success?console.log("保存成功"):console.error("保存失败:",E.message)}}),l=()=>M(this,null,function*(){console.log("导入成功，刷新数据"),yield I()}),n=()=>M(this,null,function*(){V.value=!0;try{const z=yield B();z.success?console.log(z.message):(console.error("导出失败:",z.message),alert(z.message))}finally{V.value=!1}});return(z,P)=>(p(),f("div",os,[e("div",ls,[e("div",as,[e("div",ns,[e("button",{onClick:G,class:"flex items-center gap-2 px-4 py-2 text-gray-700 bg-white rounded-md shadow hover:bg-gray-50 transition-colors"},[...P[6]||(P[6]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1),Q(" 返回看板 ",-1)])]),e("div",null,[e("h1",rs,_($(C).shop_name||$(C).name||"店铺详情"),1),e("p",is,[Q(_($(b).task_name||$(b).name||"")+" ",1),$(b).task_type?(p(),f("span",ds," - "+_($(b).task_type),1)):D("",!0)])])]),e("div",us,[$(a)?(p(),f("button",{key:0,onClick:P[0]||(P[0]=E=>T.value=!0),class:"px-4 py-2 text-blue-700 bg-blue-50 rounded-md shadow hover:bg-blue-100 transition-colors",title:"单品导入"},[...P[7]||(P[7]=[e("svg",{class:"w-5 h-5 inline-block mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1),Q(" 单品导入 ",-1)])])):D("",!0),$(a)?(p(),f("button",{key:1,onClick:P[1]||(P[1]=E=>F.value=!0),class:"px-4 py-2 text-purple-700 bg-purple-50 rounded-md shadow hover:bg-purple-100 transition-colors",title:"添加商品"},[...P[8]||(P[8]=[e("svg",{class:"w-5 h-5 inline-block mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})],-1),Q(" 添加商品 ",-1)])])):D("",!0),e("button",{onClick:n,disabled:V.value,class:"px-4 py-2 text-green-700 bg-green-50 rounded-md shadow hover:bg-green-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"导出Excel"},[P[9]||(P[9]=e("svg",{class:"w-5 h-5 inline-block mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})],-1)),V.value?(p(),f("span",gs,"导出中...")):(p(),f("span",ms,"导出Excel"))],8,cs),e("button",{onClick:s,class:"px-4 py-2 text-gray-700 bg-white rounded-md shadow hover:bg-gray-50 transition-colors",title:"刷新数据"},[...P[10]||(P[10]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1)])])])])]),$(g)?(p(),f("div",vs,[...P[11]||(P[11]=[e("div",{class:"text-center"},[e("div",{class:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"}),e("div",{class:"mt-4 text-gray-600"},"正在加载数据...")],-1)])])):$(c)?(p(),f("div",fs,[e("div",ps,_($(c)),1),e("button",{onClick:s,class:"mt-4 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"}," 重试 ")])):(p(),f("div",bs,[J(Re,{statistics:$(x)},null,8,["statistics"]),J(Me,{filters:$(m),"filter-options":$(v),"onUpdate:filters":$(j)},null,8,["filters","filter-options","onUpdate:filters"]),J(we,{data:$(K)(),columns:$(W)(),headers:$(X)(),"can-edit":$(a),loading:$(g),error:$(c),onDataChange:o},null,8,["data","columns","headers","can-edit","loading","error"]),J(ot,{"current-page":$(y).currentPage,"page-size":$(y).pageSize,"total-items":$(u),"total-pages":$(h),"page-size-options":$(y).pageSizeOptions,"onUpdate:currentPage":P[2]||(P[2]=E=>$(w)({currentPage:E})),"onUpdate:pageSize":P[3]||(P[3]=E=>$(w)({pageSize:E}))},null,8,["current-page","page-size","total-items","total-pages","page-size-options"])])),J(wt,{show:T.value,"store-id":r.storeId,"task-id":r.taskId,onClose:P[4]||(P[4]=E=>T.value=!1),onSuccess:l},null,8,["show","store-id","task-id"]),J(ss,{show:F.value,"store-id":r.storeId,"task-id":r.taskId,"existing-products":$(i),onClose:P[5]||(P[5]=E=>F.value=!1),onSuccess:l},null,8,["show","store-id","task-id","existing-products"])]))}},_s=L(ys,[["__scopeId","data-v-9b3dc632"]]);export{_s as default};
