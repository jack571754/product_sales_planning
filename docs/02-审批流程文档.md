# 审批流程功能文档

> **版本**: 1.0.0  
> **最后更新**: 2025-12-13  
> **相关页面**: 店铺详情页 (`/planning/store-detail/:storeId/:taskId`)

---

## 📋 目录

1. [功能概述](#功能概述)
2. [审批流程说明](#审批流程说明)
3. [用户界面](#用户界面)
4. [操作指南](#操作指南)
5. [权限控制](#权限控制)
6. [技术实现](#技术实现)
7. [常见问题](#常见问题)

---

## 功能概述

### 1.1 审批流程简介

审批流程功能为销售计划提供多级审批管理，确保计划数据经过适当的审核和批准后才能执行。系统支持灵活的审批流程配置，可根据不同的业务场景设置不同的审批规则。

### 1.2 核心特性

- ✅ **多级审批**: 支持配置多个审批步骤
- ✅ **灵活分配**: 基于角色、店铺属性或店铺范围分配审批人
- ✅ **状态追踪**: 实时显示审批进度和当前状态
- ✅ **操作记录**: 完整的审批历史记录
- ✅ **权限控制**: 基于角色和状态的操作权限
- ✅ **撤回机制**: 支持提交人撤回待审批的申请

### 1.3 适用场景

- 月度常规计划(MON)的审批
- 专项促销活动(PRO)的审批
- 多店铺计划的统一审批管理

---

## 审批流程说明

### 2.1 审批状态

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| **未开始** | 初始状态，未提交审批 | 提交审批 |
| **待审批** | 已提交，等待审批人处理 | 撤回审批（提交人）<br>审批通过/驳回（审批人） |
| **已通过** | 审批通过，流程完成 | 无 |
| **已驳回** | 审批被驳回，需要修改 | 重新提交审批 |

### 2.2 状态流转图

```
┌─────────┐
│ 未开始  │
└────┬────┘
     │ 提交审批
     ↓
┌─────────┐     撤回      ┌─────────┐
│ 待审批  │ ←─────────── │ 待审批  │
└────┬────┘               └─────────┘
     │
     ├─→ 审批通过 → ┌─────────┐
     │              │ 已通过  │
     │              └─────────┘
     │
     └─→ 驳回 → ┌─────────┐
                 │ 已驳回  │
                 └────┬────┘
                      │ 重新提交
                      ↓
                 ┌─────────┐
                 │ 待审批  │
                 └─────────┘
```

### 2.3 审批步骤

审批流程可配置多个步骤，每个步骤包含：

- **步骤顺序**: 审批的先后顺序
- **步骤名称**: 步骤的描述（如"店长审批"、"区域经理审批"）
- **审批人角色**: 该步骤需要的审批人角色
- **是否最终步骤**: 标识是否为最后一个审批步骤

**示例配置**:
```
步骤1: 店长审批 (角色: 店长)
步骤2: 区域经理审批 (角色: 区域经理)
步骤3: 总监审批 (角色: 总监) [最终步骤]
```

### 2.4 审批人分配方式

系统支持三种审批人分配方式：

#### 1. 基于角色 (role_based)
- 所有拥有指定角色的用户都可以审批
- 适用于通用审批场景

#### 2. 基于店铺属性 (store_attribute_based)
- 根据店铺的属性字段匹配审批人
- 适用于按店铺特征分配审批人的场景
- 示例：按店铺区域、店铺类型等

#### 3. 基于店铺范围 (store_range_based)
- 为特定审批人分配负责的店铺列表
- 适用于明确划分审批范围的场景
- 通过 `Approver Store Assignment` 配置

---

## 用户界面

### 3.1 审批状态卡片

审批状态卡片显示在店铺详情页面顶部，包含以下信息：

```
┌─────────────────────────────────────────┐
│ 📋 审批状态              [查看历史]     │
├─────────────────────────────────────────┤
│                                         │
│  当前状态: [待审批] 🔵                  │
│                                         │
│  审批流程:                              │
│  ● 第一级审批 (店长) ✓                 │
│  ● 第二级审批 (区域经理) ← 当前        │
│  ○ 第三级审批 (总监)                   │
│                                         │
│  [提交审批] [撤回审批]                  │
│  [审批通过] [驳回 ▼]                   │
│                                         │
└─────────────────────────────────────────┘
```

### 3.2 状态颜色方案

| 状态 | 颜色 | 图标 |
|------|------|------|
| 未开始 | 灰色 | ○ |
| 待审批 | 蓝色 | ● |
| 已通过 | 绿色 | ✓ |
| 已驳回 | 红色 | ✗ |

### 3.3 审批历史对话框

点击"查看历史"按钮打开审批历史对话框，以时间线形式展示：

```
● 提交 (蓝色)
│ 操作人: 张三
│ 时间: 2025-12-13 10:30
│ 说明: 提交审批
│
● 通过 (绿色)
│ 操作人: 李四
│ 时间: 2025-12-13 11:00
│ 步骤: 第1级
│ 意见: 同意
│
● 退回提交人 (红色)
  操作人: 王五
  时间: 2025-12-13 14:00
  步骤: 第2级
  原因: 数据需要修正
```

---

## 操作指南

### 4.1 提交审批

**操作步骤**:
1. 在店铺详情页面添加商品计划数据
2. 点击审批状态卡片中的"提交审批"按钮
3. 在弹出的对话框中输入提交说明（可选）
4. 点击"确认提交"

**前置条件**:
- 用户是店铺负责人
- 状态为"未开始"或"已驳回"
- 至少有一条商品计划数据

**结果**:
- 状态变为"待审批"
- 商品数据变为只读，不可编辑
- 通知第一级审批人

### 4.2 撤回审批

**操作步骤**:
1. 在待审批状态下，点击"撤回审批"按钮
2. 在确认对话框中输入撤回原因（可选）
3. 点击"确认撤回"

**前置条件**:
- 用户是提交人
- 状态为"待审批"
- 尚未有审批人处理

**结果**:
- 状态恢复为"未开始"
- 商品数据恢复可编辑
- 审批历史中记录撤回操作

### 4.3 审批通过

**操作步骤**:
1. 审批人进入店铺详情页面
2. 查看商品计划数据
3. 点击"审批通过"按钮
4. 输入审批意见（可选）
5. 点击"确认通过"

**前置条件**:
- 用户是当前步骤的审批人
- 状态为"待审批"
- 当前步骤轮到该用户审批

**结果**:
- 如果是最后一步：状态变为"已通过"，流程完成
- 如果不是最后一步：进入下一审批步骤，通知下一级审批人
- 审批历史中记录通过操作

### 4.4 驳回审批

**操作步骤**:
1. 审批人进入店铺详情页面
2. 点击"驳回"下拉菜单
3. 选择驳回类型：
   - **退回上一级**: 退回到上一个审批步骤
   - **退回提交人**: 直接退回给提交人
4. 输入驳回原因（必填）
5. 点击"确认驳回"

**前置条件**:
- 用户是当前步骤的审批人
- 状态为"待审批"

**结果**:
- 状态变为"已驳回"
- 商品数据恢复可编辑（如果退回提交人）
- 通知相关人员
- 审批历史中记录驳回操作和原因

---

## 权限控制

### 5.1 提交审批权限

```javascript
canSubmit = 
  用户是店铺负责人 &&
  (状态为"未开始" || 状态为"已驳回") &&
  有商品数据
```

### 5.2 撤回审批权限

```javascript
canWithdraw = 
  用户是提交人 &&
  状态为"已提交" &&
  审批状态为"待审批"
```

### 5.3 审批权限

```javascript
canApprove = 
  用户角色包含当前步骤要求的角色 &&
  审批状态为"待审批" &&
  (
    审批类型为"基于角色" ||
    (审批类型为"基于店铺范围" && 用户负责该店铺) ||
    (审批类型为"基于店铺属性" && 用户匹配店铺属性)
  )
```

### 5.4 编辑权限

```javascript
canEdit = 
  用户是店铺负责人 &&
  (
    状态为"未开始" ||
    (状态为"已驳回" && can_edit标志为true)
  )
```

---

## 技术实现

### 6.1 前端架构

#### Composable: useApproval.js

负责管理审批相关的所有状态和操作：

**状态管理**:
- `approvalStatus` - 审批状态数据
- `approvalHistory` - 审批历史记录
- `submitting/withdrawing/approving` - 操作加载状态

**计算属性**:
- `hasWorkflow` - 是否有审批流程
- `currentStatus` - 当前审批状态
- `canSubmit/canWithdraw/canApprove` - 权限判断
- `workflowSteps` - 审批步骤列表

**方法**:
- `fetchApprovalStatus()` - 获取审批状态
- `fetchApprovalHistory()` - 获取审批历史
- `submitForApproval(comment)` - 提交审批
- `withdrawApproval(comment)` - 撤回审批
- `approveTask(action, comment)` - 审批操作

#### 组件: ApprovalStatusCard.vue

审批状态卡片组件，负责UI展示和用户交互：

**功能**:
- 显示当前审批状态和进度
- 提供审批操作按钮
- 展示审批历史对话框
- 处理用户输入和确认

### 6.2 后端API

#### 获取审批状态
```python
@frappe.whitelist()
def get_approval_status(task_id, store_id):
    """
    获取任务店铺的审批状态
    
    返回:
    {
        "workflow": {
            "has_workflow": true,
            "workflow": {...},
            "current_state": {...}
        },
        "history": [...],
        "can_edit": false,
        "can_approve": true,
        "user_roles": [...]
    }
    """
```

#### 提交审批
```python
@frappe.whitelist()
def submit_for_approval(task_id, store_id, comment=""):
    """
    提交审批
    
    参数:
    - task_id: 任务ID
    - store_id: 店铺ID
    - comment: 提交说明
    
    返回:
    {
        "status": "success",
        "message": "提交成功",
        "workflow_id": "...",
        "next_approver_role": "..."
    }
    """
```

#### 审批操作
```python
@frappe.whitelist()
def approve_task_store(task_id, store_id, action, comments=""):
    """
    审批操作
    
    参数:
    - task_id: 任务ID
    - store_id: 店铺ID
    - action: "approve" | "reject_to_previous" | "reject_to_submitter"
    - comments: 审批意见/驳回原因
    
    返回:
    {
        "status": "success",
        "message": "操作成功"
    }
    """
```

### 6.3 数据模型

#### Approval Workflow (审批工作流)
```
- name: 工作流ID
- workflow_name: 工作流名称
- task_type: 任务类型 (MON/PRO)
- is_active: 是否启用
- steps: 审批步骤列表（子表）
```

#### Approval Workflow Step (审批步骤)
```
- step_order: 步骤顺序
- step_name: 步骤名称
- approver_role: 审批人角色
- assignment_type: 分配方式
- is_final: 是否最终步骤
```

#### Approval History (审批历史)
```
- task_id: 任务ID
- store_id: 店铺ID
- approval_step: 审批步骤
- approver: 操作人
- action: 操作类型
- comments: 意见/原因
- action_time: 操作时间
```

---

## 常见问题

### 7.1 审批按钮不显示

**问题**: 进入店铺详情页面后，看不到审批相关按钮

**可能原因**:
1. 该任务没有配置审批流程
2. 用户没有相应的操作权限
3. 当前状态不允许该操作

**解决方法**:
1. 检查任务类型是否配置了审批工作流
2. 确认用户角色是否正确
3. 查看浏览器控制台是否有错误信息

### 7.2 提交审批失败

**问题**: 点击提交审批后提示失败

**可能原因**:
1. 没有商品计划数据
2. 审批流程未正确配置
3. 用户权限不足

**解决方法**:
1. 确保至少添加了一条商品计划
2. 检查审批工作流配置是否完整
3. 确认用户是店铺负责人
4. 查看后端错误日志

### 7.3 审批历史不显示

**问题**: 点击"查看历史"后对话框为空

**可能原因**:
1. 该任务店铺尚未有审批操作
2. API调用失败
3. 数据格式错误

**解决方法**:
1. 确认是否已经提交过审批
2. 检查网络请求是否成功
3. 查看浏览器控制台错误

### 7.4 审批后数据仍可编辑

**问题**: 提交审批后商品数据仍然可以编辑

**可能原因**:
1. 前端权限判断未生效
2. 后端权限检查有问题
3. 缓存未刷新

**解决方法**:
1. 刷新页面重新加载数据
2. 检查 `canEdit` 计算属性
3. 清除浏览器缓存

### 7.5 无法撤回审批

**问题**: 提交审批后无法撤回

**可能原因**:
1. 审批人已经处理
2. 用户不是提交人
3. 状态已经改变

**解决方法**:
1. 确认审批状态仍为"待审批"
2. 确认当前用户是提交人
3. 联系审批人处理

---

## 最佳实践

### 8.1 审批流程配置建议

1. **步骤数量**: 建议不超过5个审批步骤，避免流程过长
2. **角色设置**: 确保每个步骤的审批人角色有明确的用户
3. **最终步骤**: 必须标记最后一个步骤为"最终步骤"
4. **测试验证**: 配置完成后进行完整流程测试

### 8.2 操作建议

1. **提交前检查**: 提交审批前仔细检查商品数据
2. **及时处理**: 审批人应及时处理待审批事项
3. **明确意见**: 审批时填写清晰的审批意见
4. **驳回说明**: 驳回时必须说明具体原因

### 8.3 权限管理建议

1. **角色分配**: 合理分配用户角色，避免权限混乱
2. **定期审查**: 定期审查审批人配置是否合理
3. **权限最小化**: 遵循最小权限原则

---

## 相关文档

- [项目文档](./项目文档.md) - 项目整体说明
- [店铺详情页文档](./店铺详情页文档.md) - 店铺详情页功能
- [CLAUDE.md](./CLAUDE.md) - 完整开发指南

---

**版本**: 1.0.0  
**最后更新**: 2025-12-13  
**维护者**: 开发团队