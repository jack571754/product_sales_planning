# 店铺详情页功能文档

> **版本**: 1.0.0  
> **最后更新**: 2025-12-13  
> **页面路由**: `/planning/store-detail/:storeId/:taskId`

---

## 📋 目录

1. [页面概述](#页面概述)
2. [功能模块](#功能模块)
3. [用户界面](#用户界面)
4. [操作指南](#操作指南)
5. [技术实现](#技术实现)
6. [常见问题](#常见问题)

---

## 页面概述

### 1.1 页面简介

店铺详情页是销售计划系统的核心页面，用于管理特定店铺在特定任务下的商品销售计划。页面集成了商品管理、审批流程、数据导入导出等完整功能。

### 1.2 核心功能

- ✅ **商品计划管理**: 添加、编辑、删除商品计划
- ✅ **批量操作**: 批量导入、导出、更新、删除
- ✅ **机制应用**: 自动应用促销机制
- ✅ **审批集成**: 内嵌审批状态和操作
- ✅ **筛选排序**: 灵活的数据筛选和排序
- ✅ **分页展示**: 支持大数据量分页加载
- ✅ **实时统计**: 显示商品数量和金额统计

### 1.3 页面访问

**URL格式**: `/planning/store-detail/:storeId/:taskId`

**示例**: `/planning/store-detail/SC-5-744/2025-12-MON-745`

**参数说明**:
- `storeId`: 店铺ID
- `taskId`: 任务ID

---

## 功能模块

### 2.1 页面头部

#### 统计卡片
显示当前店铺计划的关键统计数据：

- **商品总数**: 已添加的商品计划数量
- **总金额**: 所有商品的金额总和
- **平均单价**: 商品的平均价格
- **其他统计**: 根据业务需求自定义

#### 审批状态卡片
显示当前任务店铺的审批状态和操作按钮。详见 [审批流程文档](./02-审批流程文档.md)

### 2.2 筛选面板

提供多维度的数据筛选功能：

**筛选条件**:
- **商品编码**: 按商品编码搜索
- **商品名称**: 按商品名称搜索
- **机制类型**: 按促销机制筛选
- **数量范围**: 按数量区间筛选
- **金额范围**: 按金额区间筛选

**操作按钮**:
- **应用筛选**: 执行筛选操作
- **清除筛选**: 重置所有筛选条件
- **导出数据**: 导出当前筛选结果

### 2.3 工具栏

提供常用的批量操作功能：

**主要操作**:
- **添加商品**: 打开商品选择对话框
- **批量导入**: 从Excel导入商品数据
- **批量导出**: 导出商品数据到Excel
- **批量删除**: 删除选中的商品
- **应用机制**: 批量应用促销机制
- **刷新数据**: 重新加载商品列表

### 2.4 商品列表

以表格形式展示商品计划数据：

**表格列**:
- **选择框**: 用于批量操作
- **商品编码**: 商品的唯一标识
- **商品名称**: 商品的名称
- **规格**: 商品规格信息
- **单位**: 计量单位
- **数量**: 计划销售数量（可编辑）
- **单价**: 商品单价
- **金额**: 数量×单价
- **机制**: 应用的促销机制
- **备注**: 备注信息
- **操作**: 编辑、删除按钮

**交互功能**:
- **行内编辑**: 双击单元格直接编辑
- **批量选择**: 勾选多行进行批量操作
- **排序**: 点击列头进行排序
- **分页**: 底部分页控件

### 2.5 分页控件

提供数据分页功能：

- **每页显示**: 10/20/50/100条
- **页码跳转**: 快速跳转到指定页
- **总数显示**: 显示总记录数
- **上一页/下一页**: 翻页按钮

---

## 用户界面

### 3.1 页面布局

```
┌─────────────────────────────────────────────────────────┐
│ 顶部导航栏                                               │
├─────────────────────────────────────────────────────────┤
│ 面包屑: 首页 > 计划看板 > 店铺详情                      │
├─────────────────────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│ │商品总数 │ │ 总金额  │ │平均单价 │ │ 其他    │       │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │
├─────────────────────────────────────────────────────────┤
│ 审批状态卡片 (如果有审批流程)                           │
├─────────────────────────────────────────────────────────┤
│ 筛选面板                                                 │
│ [商品编码] [商品名称] [机制] [应用] [清除] [导出]      │
├─────────────────────────────────────────────────────────┤
│ 工具栏                                                   │
│ [添加] [导入] [导出] [删除] [应用机制] [刷新]          │
├─────────────────────────────────────────────────────────┤
│ 商品列表表格                                             │
│ ┌──┬────────┬────────┬──────┬──────┬──────┬──────┐   │
│ │☐│商品编码│商品名称│ 数量 │ 单价 │ 金额 │ 操作 │   │
│ ├──┼────────┼────────┼──────┼──────┼──────┼──────┤   │
│ │☐│ P001   │ 商品A  │ 100  │ 10.0 │ 1000 │ 编辑 │   │
│ │☐│ P002   │ 商品B  │ 200  │ 15.0 │ 3000 │ 删除 │   │
│ └──┴────────┴────────┴──────┴──────┴──────┴──────┘   │
├─────────────────────────────────────────────────────────┤
│ 分页控件                                                 │
│ 每页: [20▼] 共100条 [<] 1/5 [>] 跳转: [__] [Go]       │
└─────────────────────────────────────────────────────────┘
```

### 3.2 响应式设计

**桌面端** (>1024px):
- 完整显示所有列
- 侧边栏展开
- 工具栏横向排列

**平板端** (768px-1024px):
- 隐藏部分次要列
- 侧边栏可折叠
- 工具栏部分折叠

**移动端** (<768px):
- 卡片式展示
- 侧边栏隐藏
- 工具栏下拉菜单

---

## 操作指南

### 4.1 添加商品

**方式一：单个添加**

1. 点击工具栏的"添加商品"按钮
2. 在弹出的商品选择对话框中搜索商品
3. 选择要添加的商品
4. 输入计划数量
5. 点击"确认添加"

**方式二：批量导入**

1. 点击"批量导入"按钮
2. 下载导入模板（如果需要）
3. 填写Excel模板
4. 上传填好的Excel文件
5. 系统验证数据并导入

**前置条件**:
- 用户有编辑权限
- 任务状态允许编辑（未提交审批或已驳回）

### 4.2 编辑商品

**行内编辑**:
1. 双击要编辑的单元格
2. 修改数值
3. 按Enter或点击其他地方保存

**批量编辑**:
1. 勾选要编辑的商品
2. 点击"批量更新"按钮
3. 在对话框中输入新的数值
4. 选择要更新的字段
5. 点击"确认更新"

**注意事项**:
- 只能编辑数量、备注等可编辑字段
- 商品编码、名称等基础信息不可修改
- 编辑后金额自动重新计算

### 4.3 删除商品

**单个删除**:
1. 点击商品行的"删除"按钮
2. 在确认对话框中点击"确认"

**批量删除**:
1. 勾选要删除的商品
2. 点击工具栏的"批量删除"按钮
3. 在确认对话框中点击"确认"

**按编码删除**:
1. 点击"按编码删除"按钮
2. 输入或粘贴商品编码列表（每行一个）
3. 点击"确认删除"

### 4.4 应用机制

**操作步骤**:
1. 点击"应用机制"按钮
2. 选择要应用的机制类型
3. 选择目标商品（全部或选中）
4. 点击"确认应用"

**机制类型**:
- **折扣机制**: 按比例调整价格
- **赠品机制**: 添加赠品商品
- **满减机制**: 满足条件减免金额
- **自定义机制**: 根据配置应用

**效果**:
- 自动更新商品的机制字段
- 可能影响价格和数量
- 记录机制应用历史

### 4.5 导入导出

**导出数据**:
1. 应用筛选条件（可选）
2. 点击"导出数据"按钮
3. 选择导出格式（Excel/CSV）
4. 下载生成的文件

**导入数据**:
1. 点击"批量导入"按钮
2. 下载模板（首次导入）
3. 填写Excel模板：
   - 商品编码（必填）
   - 商品名称（必填）
   - 数量（必填）
   - 其他字段（可选）
4. 上传文件
5. 查看导入结果

**导入规则**:
- 如果商品已存在，更新数量
- 如果商品不存在，新增记录
- 验证失败的行会在结果中标注

### 4.6 筛选和排序

**筛选操作**:
1. 在筛选面板输入筛选条件
2. 点击"应用筛选"按钮
3. 查看筛选结果
4. 点击"清除筛选"恢复全部数据

**排序操作**:
1. 点击表格列头
2. 第一次点击：升序
3. 第二次点击：降序
4. 第三次点击：取消排序

**支持的筛选条件**:
- 文本搜索：商品编码、名称
- 数值范围：数量、金额
- 下拉选择：机制类型
- 日期范围：创建时间、更新时间

---

## 技术实现

### 5.1 前端架构

#### Composable: useStoreDetail.js

负责管理店铺详情页的所有状态和业务逻辑：

**状态管理**:
```javascript
const commodityData = ref([])      // 商品数据
const statistics = ref({})         // 统计数据
const filters = ref({})            // 筛选条件
const pagination = ref({})         // 分页信息
const selectedItems = ref([])      // 选中的商品
const loading = ref(false)         // 加载状态
```

**计算属性**:
```javascript
const canEdit = computed(() => {
  // 判断是否可编辑
  return !isApproving && hasPermission
})

const totalAmount = computed(() => {
  // 计算总金额
  return commodityData.value.reduce((sum, item) => 
    sum + (item.quantity * item.price), 0
  )
})
```

**主要方法**:
```javascript
fetchCommodityData()        // 获取商品数据
addCommodity(items)         // 添加商品
updateCommodity(id, data)   // 更新商品
deleteCommodity(ids)        // 删除商品
batchUpdate(ids, data)      // 批量更新
importData(file)            // 导入数据
exportData(filters)         // 导出数据
applyMechanism(type, ids)   // 应用机制
```

#### 组件结构

```
StoreDetail.vue (主页面)
├── StatsCards.vue (统计卡片)
├── ApprovalStatusCard.vue (审批状态卡片)
├── FilterPanel.vue (筛选面板)
├── Toolbar.vue (工具栏)
├── CommodityTable.vue (商品表格)
│   ├── TableHeader.vue (表头)
│   ├── TableRow.vue (表格行)
│   └── TableCell.vue (单元格)
├── PaginationControls.vue (分页控件)
└── Dialogs/
    ├── AddCommodityDialog.vue (添加商品对话框)
    ├── ImportDialog.vue (导入对话框)
    ├── MechanismDialog.vue (机制对话框)
    └── ConfirmDialog.vue (确认对话框)
```

### 5.2 后端API

#### 获取商品数据
```python
@frappe.whitelist()
def get_store_commodity_data(store_id, task_id, filters=None, 
                             page=1, page_size=20, sort_by=None):
    """
    获取店铺商品计划数据
    
    参数:
    - store_id: 店铺ID
    - task_id: 任务ID
    - filters: 筛选条件（JSON字符串）
    - page: 页码
    - page_size: 每页数量
    - sort_by: 排序字段
    
    返回:
    {
        "data": [...],
        "total": 100,
        "statistics": {...},
        "can_edit": true
    }
    """
```

#### 批量插入商品
```python
@frappe.whitelist()
def bulk_insert_commodity_schedule(store_id, task_id, items):
    """
    批量插入商品计划
    
    参数:
    - store_id: 店铺ID
    - task_id: 任务ID
    - items: 商品列表（JSON字符串）
    
    返回:
    {
        "status": "success",
        "message": "成功添加10条记录",
        "inserted_count": 10
    }
    """
```

#### 批量更新数量
```python
@frappe.whitelist()
def batch_update_quantity(updates):
    """
    批量更新商品数量
    
    参数:
    - updates: 更新列表 [{"name": "...", "quantity": 100}, ...]
    
    返回:
    {
        "status": "success",
        "message": "成功更新10条记录",
        "updated_count": 10
    }
    """
```

### 5.3 数据流

```
用户操作
    ↓
Vue组件 (StoreDetail.vue)
    ↓
Composable (useStoreDetail.js)
    ↓
API调用 (frappe-ui call)
    ↓
后端API (commodity.py)
    ↓
服务层 (CommodityScheduleService)
    ↓
数据库 (Commodity Schedule)
    ↓
返回响应
    ↓
更新Vue状态
    ↓
UI更新
```

### 5.4 性能优化

**前端优化**:
- 虚拟滚动：大数据量表格使用虚拟滚动
- 防抖节流：搜索输入使用防抖
- 懒加载：分页加载数据
- 缓存：缓存筛选选项和统计数据

**后端优化**:
- 索引：task_id + store_id 组合索引
- 批量操作：使用SQL批量插入/更新
- 分页查询：限制单次查询数量
- 缓存：缓存常用的筛选选项

---

## 常见问题

### 6.1 页面加载慢

**问题**: 打开店铺详情页面加载时间过长

**可能原因**:
1. 商品数据量过大
2. 网络延迟
3. 服务器性能问题

**解决方法**:
1. 减小每页显示数量
2. 使用筛选条件减少数据量
3. 检查网络连接
4. 联系管理员优化数据库

### 6.2 无法编辑商品

**问题**: 点击编辑按钮无反应或提示无权限

**可能原因**:
1. 任务已提交审批
2. 用户权限不足
3. 任务状态不允许编辑

**解决方法**:
1. 检查审批状态，如需修改请先撤回审批
2. 确认用户角色权限
3. 查看任务状态是否为可编辑状态

### 6.3 导入失败

**问题**: 上传Excel文件后提示导入失败

**可能原因**:
1. Excel格式不正确
2. 必填字段缺失
3. 数据验证失败
4. 文件过大

**解决方法**:
1. 使用系统提供的模板
2. 检查必填字段是否完整
3. 查看错误提示，修正数据
4. 分批导入大量数据

### 6.4 统计数据不准确

**问题**: 页面顶部显示的统计数据与实际不符

**可能原因**:
1. 缓存未刷新
2. 筛选条件影响
3. 数据同步延迟

**解决方法**:
1. 点击刷新按钮重新加载
2. 清除筛选条件查看全部数据
3. 刷新浏览器页面

### 6.5 批量操作失败

**问题**: 批量删除或更新时部分失败

**可能原因**:
1. 部分商品被锁定
2. 权限不足
3. 数据验证失败

**解决方法**:
1. 查看失败记录的具体原因
2. 逐个处理失败的记录
3. 检查数据是否符合规则

---

## 最佳实践

### 7.1 数据管理建议

1. **定期保存**: 编辑数据后及时保存
2. **备份导出**: 重要数据定期导出备份
3. **分批操作**: 大量数据分批处理
4. **验证数据**: 导入前验证数据格式

### 7.2 性能优化建议

1. **合理分页**: 根据数据量选择合适的每页数量
2. **使用筛选**: 通过筛选减少显示的数据量
3. **避免频繁刷新**: 不要过于频繁地刷新页面
4. **批量操作**: 尽量使用批量操作而非逐个操作

### 7.3 操作流程建议

1. **先筛选后操作**: 批量操作前先筛选出目标数据
2. **确认后提交**: 重要操作前仔细确认
3. **记录备注**: 为特殊商品添加备注说明
4. **及时审批**: 完成编辑后及时提交审批

---

## 相关文档

- [项目总览文档](./01-项目总览文档.md) - 项目整体说明
- [审批流程文档](./02-审批流程文档.md) - 审批流程详细说明
- [CLAUDE.md](../CLAUDE.md) - 完整开发指南
- [API文档](../API_QUICK_REFERENCE.md) - API接口说明

---

**版本**: 1.0.0  
**最后更新**: 2025-12-13  
**维护者**: 开发团队